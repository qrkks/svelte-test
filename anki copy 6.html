<style>
  /* å…¨å±€å­—ä½“è®¾ç½® */
  #front,
  #back,
  #front *,
  #back * {
    font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", "Helvetica Neue", Arial,
      sans-serif;
  }

  /* ä¿æŒä»£ç ç­‰å®½å­—ä½“ */
  #front pre,
  #back pre,
  #front code,
  #back code,
  #front pre *,
  #back pre *,
  #front code *,
  #back code * {
    font-family: "Consolas", "Monaco", "Courier New", monospace;
  }

  /* æ­£å¸¸æ ·å¼ */
  #front,
  #back {
    font-size: 20px;
    color: black;
    background-color: white;
    line-height: 1.6;
  }
  .card {
    color: black;
    background-color: white;
  }

  /* ä»£ç å—æ ·å¼ */
  pre {
    position: relative;
    background: #f8f8f8;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin: 10px 0;
    overflow: auto;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap !important; /* å¼ºåˆ¶ä¿æŒæ¢è¡Œå¹¶å…è®¸è‡ªåŠ¨æŠ˜è¡Œ */
    word-wrap: break-word; /* é•¿è¡Œè‡ªåŠ¨æŠ˜è¡Œ */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  pre code {
    background: transparent;
    padding: 0;
    border: none;
    font-size: 18px;
    line-height: 1.5;
    white-space: pre-wrap !important; /* ç¡®ä¿ä»£ç å†…å®¹ä¿æŒæ¢è¡Œ */
    word-wrap: break-word; /* ç¡®ä¿é•¿è¡Œèƒ½æ­£ç¡®æŠ˜è¡Œ */
    display: block; /* ç¡®ä¿æ˜¯å—çº§å…ƒç´  */
  }

  /* è¯­è¨€æ ‡è¯†ç¬¦æ ·å¼ */
  .code-lang-label {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #5f8f55;
    color: white;
    padding: 2px 8px;
    font-size: 12px;
    font-weight: bold;
    border-radius: 0 4px 0 4px;
    text-transform: uppercase;
    font-family: "Consolas", "Monaco", "Courier New", monospace;
    z-index: 100;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }

  .code-lang-label:hover {
    background: #10b981;
    box-shadow: 0 2px 8px rgba(52, 211, 153, 0.3);
  }

  .code-lang-label:active {
    background: #059669;
    box-shadow: 0 1px 4px rgba(52, 211, 153, 0.5);
  }

  .code-lang-label.copied {
    background: #10b981;
    animation: pulse 0.3s ease;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 rgba(52, 211, 153, 0.7);
    }
    50% {
      box-shadow: 0 0 20px rgba(52, 211, 153, 0.7);
    }
    100% {
      box-shadow: 0 0 0 rgba(52, 211, 153, 0.7);
    }
  }

  /* è¡Œå†…ä»£ç  */
  code {
    background: #f1f1f1;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
    color: #333; /* æ”¹ä¸ºæ·±ç°è‰²ï¼Œä¸è¦çº¢è‰² */
  }

  /* æ ‡ç­¾æ ·å¼ */
  .tags {
    text-align: center;
    margin-top: 10px;
  }
  .tag::before {
    content: "#";
  }
  .tag:empty {
    display: none;
  }
  .tag {
    color: white;
    background-color: #9f2bff;
    border: none;
    font-size: 11px;
    font-weight: bold;
    padding: 3px 8px;
    margin: 0px 3px;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    border-radius: 14px;
    display: inline-block;
    vertical-align: middle;
  }

  /* cloze é«˜äº® */
  .cloze {
    font-weight: bold;
    color: blue;
  }
  .nightMode .cloze {
    color: lightblue;
  }

  /* å›¾ç‰‡æ ·å¼ */
  img {
    max-width: 100%;
    max-height: 80vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†çª—é«˜åº¦çš„80% */
    height: auto;
    width: auto; /* ç¡®ä¿å®½åº¦ä¹Ÿèƒ½è‡ªåŠ¨è°ƒæ•´ */
    display: block;
    margin: 10px auto;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    object-fit: contain; /* ç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¿æŒæ¯”ä¾‹ */
  }

  /* æš—é»‘æ¨¡å¼ */
  .nightMode #front,
  .nightMode #back,
  .nightMode .card {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }
  .nightMode img {
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
  }
  .nightMode pre {
    background: #0d1117 !important;
    border-color: #30363d !important;
    box-shadow: none;
  }
  .nightMode code {
    background: #21262d;
    color: inherit;
  }
  .nightMode pre code {
    background: transparent;
  }
  .nightMode .tag {
    background-color: #ffffff33;
    color: #ffffff;
  }
  .nightMode .code-lang-label {
    background: #4ade80;
    color: #ffffff;
  }

  /* ä¸‰çº¿è¡¨æ ·å¼ */
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 12px 0;
    font-size: 18px;
  }
  table thead tr {
    border-bottom: 2px solid #000;
  }
  table tbody tr:last-child {
    border-bottom: 2px solid #000;
  }
  table th {
    border-top: 2px solid #000;
    padding: 8px 12px;
    text-align: left;
  }
  table td {
    border: none;
    padding: 8px 12px;
  }
  .nightMode table thead tr {
    border-bottom: 2px solid #aaa;
  }
  .nightMode table tbody tr:last-child {
    border-bottom: 2px solid #aaa;
  }
  .nightMode table th {
    border-top: 2px solid #aaa;
  }

  /* åˆ—è¡¨æ ·å¼ */
  ul,
  ol {
    margin: 12px 0;
    padding-left: 24px;
    line-height: 1.6;
  }
  ul ul,
  ol ol,
  ul ol,
  ol ul {
    margin: 4px 0;
  }
  li {
    margin: 4px 0;
  }
  ul > li {
    list-style-type: disc;
  }
  ul ul > li {
    list-style-type: circle;
  }
  ul ul ul > li {
    list-style-type: square;
  }
  ol > li {
    list-style-type: decimal;
  }
  ol ol > li {
    list-style-type: lower-alpha;
  }
  ol ol ol > li {
    list-style-type: lower-roman;
  }

  /* é”™è¯¯æç¤ºæ ·å¼ */
  .error-message {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 4px;
    padding: 12px;
    margin: 8px 0;
    color: #c62828;
    font-size: 14px;
  }
  .nightMode .error-message {
    background: #3d1a1a;
    border: 1px solid #8b2635;
    color: #ff6b6b;
  }

  /* Mermaid ç›¸å…³æ ·å¼ */
  .mermaid {
    text-align: center;
    margin: 1em 0;
    background: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .nightMode .mermaid {
    background: #2d2d2d;
  }

  /* ä»£ç å—æš—é»‘æ¨¡å¼æ ·å¼ */
  .nightMode .hljs {
    display: block;
    overflow-x: auto;
    padding: 1em;
    color: #c9d1d9;
    background: #0d1117;
  }

  .nightMode pre {
    background: #0d1117 !important;
    border-color: #30363d !important;
    box-shadow: none;
  }

  .nightMode code {
    background: #21262d;
    color: #c9d1d9;
  }

  .nightMode pre code {
    background: transparent;
    color: #c9d1d9;
  }

  /* ç¡®ä¿ä»£ç å—ä¸­çš„æ³¨é‡Šåœ¨æš—é»‘æ¨¡å¼ä¸‹å¯è§ */
  .nightMode .hljs-comment,
  .nightMode .hljs-quote {
    color: #8b949e;
    font-style: italic;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å­—ç¬¦ä¸²é¢œè‰² */
  .nightMode .hljs-string {
    color: #a5d6ff;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å…³é”®å­—é¢œè‰² */
  .nightMode .hljs-keyword,
  .nightMode .hljs-selector-tag,
  .nightMode .hljs-deletion {
    color: #ff7b72;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„æ•°å­—é¢œè‰² */
  .nightMode .hljs-number,
  .nightMode .hljs-literal {
    color: #79c0ff;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å‡½æ•°åé¢œè‰² */
  .nightMode .hljs-function,
  .nightMode .hljs-title {
    color: #d2a8ff;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„ç±»åé¢œè‰² */
  .nightMode .hljs-class .hljs-title {
    color: #7ee787;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å˜é‡åé¢œè‰² */
  .nightMode .hljs-variable,
  .nightMode .hljs-template-variable {
    color: #ffa657;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å±æ€§åé¢œè‰² */
  .nightMode .hljs-attr,
  .nightMode .hljs-property {
    color: #79c0ff;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„æ ‡ç­¾é¢œè‰² */
  .nightMode .hljs-tag,
  .nightMode .hljs-name {
    color: #7ee787;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„æ­£åˆ™è¡¨è¾¾å¼é¢œè‰² */
  .nightMode .hljs-regexp {
    color: #a5d6ff;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„ç¬¦å·é¢œè‰² */
  .nightMode .hljs-symbol,
  .nightMode .hljs-bullet {
    color: #f2cc60;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å†…ç½®å‡½æ•°é¢œè‰² */
  .nightMode .hljs-built_in,
  .nightMode .hljs-builtin-name {
    color: #ffa657;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å…ƒä¿¡æ¯é¢œè‰² */
  .nightMode .hljs-meta {
    color: #f0883e;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„å¼ºè°ƒé¢œè‰² */
  .nightMode .hljs-emphasis {
    font-style: italic;
  }

  /* æš—é»‘æ¨¡å¼ä¸‹çš„åŠ ç²—é¢œè‰² */
  .nightMode .hljs-strong {
    font-weight: bold;
  }
</style>

<script>
  // ğŸ›¡ï¸ å®‰å…¨çš„ç¼–è¾‘æ¨¡å¼æ£€æµ‹å‡½æ•°
  function isEditModeSafe() {
    try {
      return !!(
        window.location.href.includes("editor") ||
        window.location.href.includes("browse") ||
        window.location.href.includes("add") ||
        document.querySelector('[contenteditable="true"]') ||
        document.activeElement?.tagName === "TEXTAREA" ||
        document.activeElement?.tagName === "INPUT" ||
        document.querySelector(".note-editing-area") ||
        document.querySelector(".card-fields") ||
        document.querySelector(".editor-field") ||
        document.querySelector("#fields") ||
        document.body?.classList?.contains("editor") ||
        document.title.includes("ç¼–è¾‘") ||
        document.title.includes("Edit") ||
        document.title.includes("Add") ||
        document.title.includes("æ–°å»º") ||
        document.title.includes("Browser") ||
        document.title.includes("æµè§ˆ")
      );
    } catch (e) {
      console.warn("ğŸš¨ ç¼–è¾‘æ¨¡å¼æ£€æµ‹å‡ºé”™ï¼Œä¸ºå®‰å…¨èµ·è§å‡è®¾ä¸ºç¼–è¾‘æ¨¡å¼:", e);
      return true;
    }
  }

  // âš¡ å¿«é€Ÿæ™ºèƒ½æ£€æµ‹å‡½æ•°
  function smartEditModeCheck(callback) {
    // ç¬¬ä¸€æ¬¡ç«‹å³æ£€æµ‹
    if (isEditModeSafe()) {
      console.log("ğŸ›‘ ç«‹å³æ£€æµ‹ï¼šå‘ç°ç¼–è¾‘æ¨¡å¼ï¼Œåœæ­¢åˆå§‹åŒ–");
      return;
    }

    // å¦‚æœURLæ˜ç¡®ä¸æ˜¯ç¼–è¾‘å™¨ï¼Œç›´æ¥å¯åŠ¨
    if (
      !window.location.href.includes("editor") &&
      !window.location.href.includes("browse")
    ) {
      console.log("âœ… URLæ£€æµ‹ï¼šæ˜ç¡®éç¼–è¾‘æ¨¡å¼ï¼Œç«‹å³å¯åŠ¨");
      callback();
      return;
    }

    // å¯¹äºå¯èƒ½çš„ç¼–è¾‘æ¨¡å¼ï¼Œå¿«é€Ÿæ£€æµ‹å‡ æ¬¡
    let checkCount = 0;
    const maxChecks = 3;
    const checkInterval = 20;

    function quickCheck() {
      checkCount++;

      if (isEditModeSafe()) {
        console.log(`ğŸ›‘ ç¬¬${checkCount}æ¬¡å¿«é€Ÿæ£€æµ‹ï¼šå‘ç°ç¼–è¾‘æ¨¡å¼ï¼Œåœæ­¢åˆå§‹åŒ–`);
        return;
      }

      if (checkCount >= maxChecks) {
        console.log("âœ… å¿«é€Ÿæ£€æµ‹ç¡®è®¤ï¼šéç¼–è¾‘æ¨¡å¼ï¼Œå¼€å§‹åˆå§‹åŒ–");
        callback();
        return;
      }

      setTimeout(quickCheck, checkInterval);
    }

    quickCheck();
  }

  // ğŸš€ ä½¿ç”¨æ™ºèƒ½å¿«é€Ÿæ£€æµ‹å¯åŠ¨
  console.log("âš¡ å¼€å§‹å¿«é€Ÿç¼–è¾‘æ¨¡å¼æ£€æµ‹");

  smartEditModeCheck(() => {
    (function () {
      // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ï¼Œå¿½ç•¥ç¼“å­˜
      window.ankiMarkdownInitialized = false;

      if (window.ankiMarkdownInitialized) return;
      window.ankiMarkdownInitialized = true;

      // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æ–°ä»£ç 
      console.log("ğŸ”„ Anki Markdown é‡æ–°åˆå§‹åŒ– - Version 2.0");

      const RESOURCES = {
        css: [
          ["_katex-0.16.22.css", "https://npm.elemecdn.com/katex@0.16.22/dist/katex.min.css"],
          ["_highlight-11.11.1.css", "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.0/styles/github.min.css"],
        ],
        scripts: [
          ["_highlight-11.11.1.js", "https://lib.baomitu.com/highlight.js/11.11.1/highlight.min.js"],
          ["_katex-0.16.22.min.js", "https://npm.elemecdn.com/katex@0.16.22/dist/katex.min.js"],
          ["_auto-render-0.16.22.js", "https://npm.elemecdn.com/katex@0.16.22/dist/contrib/auto-render.min.js"],
          ["_markdown-it-14.1.0.min.js", "https://lib.baomitu.com/markdown-it/14.1.0/markdown-it.min.js"],
          ["_markdown-it-mark.js", "https://jsd.ink/gh/Jwrede/Anki-KaTeX-Markdown/_markdown-it-mark.js"],
          ["_mhchem-0.16.22.js", "https://npm.elemecdn.com/katex@0.16.22/dist/contrib/mhchem.min.js"],
          ["_mermaid-10.9.0.min.js", "https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"],
        ],
      };

      function loadCSS([path, cdn]) {
        return new Promise((resolve, reject) => {
          if (
            document.querySelector(`link[href="${path}"], link[href="${cdn}"]`)
          )
            return resolve();
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = path;
          link.onload = () => {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ“ æœ¬åœ°";
            resolve();
          };
          link.onerror = () => {
            const fallback = document.createElement("link");
            fallback.rel = "stylesheet";
            fallback.href = cdn;
            fallback.onload = () => {
              window.resourceStatus = window.resourceStatus || {};
              window.resourceStatus[path] = "ğŸŒ CDN";
              resolve();
            };
            fallback.onerror = reject;
            document.head.appendChild(fallback);
          };
          document.head.appendChild(link);
        });
      }

      function loadScript([path, cdn]) {
        return new Promise((resolve, reject) => {
          if (cdn.includes("highlight") && window.hljs) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ’¾ ç¼“å­˜";
            return resolve();
          }
          if (cdn.includes("katex") && window.katex) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ’¾ ç¼“å­˜";
            return resolve();
          }
          if (cdn.includes("auto-render") && window.renderMathInElement) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ’¾ ç¼“å­˜";
            return resolve();
          }
          if (cdn.includes("mhchem") && window.katex?.__chemParse) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ’¾ ç¼“å­˜";
            return resolve();
          }
          if (cdn.includes("markdown-it") && window.markdownit) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ’¾ ç¼“å­˜";
            return resolve();
          }
          if (cdn.includes("markdown-it-mark") && window.markdownItMark) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ’¾ ç¼“å­˜";
            return resolve();
          }
          const script = document.createElement("script");
          script.src = path;
          script.onload = () => {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = "ğŸ“ æœ¬åœ°";
            resolve();
          };
          script.onerror = () => {
            const fallback = document.createElement("script");
            fallback.src = cdn;
            fallback.onload = () => {
              window.resourceStatus = window.resourceStatus || {};
              window.resourceStatus[path] = "ğŸŒ CDN";
              resolve();
            };
            fallback.onerror = reject;
            document.head.appendChild(fallback);
          };
          document.head.appendChild(script);
        });
      }

      function cleanHTML(text) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ä»å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç²˜è´´çš„å†…å®¹
        const isPastedContent = text.includes('</div>') || text.includes('</span>') || text.includes('</p>');
        
        // å¦‚æœæ˜¯ä»å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç²˜è´´çš„å†…å®¹ï¼Œå°è¯•æå– Markdown
        if (isPastedContent) {
          // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»£ç å—ï¼ˆå¯èƒ½æ˜¯ä» ChatGPT ç­‰æºå¤åˆ¶çš„ï¼‰
          const hasCodeBlock = text.includes('```') || text.includes('pre') || text.includes('code');
          
          if (hasCodeBlock) {
            console.log("ğŸ“ æ£€æµ‹åˆ°ä»£ç å—ï¼Œå°è¯•æå– Markdown");
            // å°è¯•ä»å‰ªè´´æ¿è·å–çº¯æ–‡æœ¬å†…å®¹
            try {
              const clipboardText = window.clipboardData?.getData('Text') || '';
              if (clipboardText && clipboardText.includes('```')) {
                console.log("âœ… æˆåŠŸä»å‰ªè´´æ¿è·å– Markdown");
                return clipboardText;
              }
            } catch (e) {
              console.log("âš ï¸ æ— æ³•è®¿é—®å‰ªè´´æ¿:", e);
            }
          }
        }

        // é¢„å¤„ç†ï¼šå…ˆè§£ç æ‰€æœ‰ HTML å®ä½“
        let tempHtml = text
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'")
          .replace(/&nbsp;/g, ' ')
          // å°†<br>æ ‡ç­¾è½¬æ¢ä¸ºå®é™…çš„æ¢è¡Œç¬¦
          .replace(/<br\s*\/?>/gi, '\n');

        // ä¿æŠ¤ä»£ç å—
        const codeBlockPlaceholders = [];
        tempHtml = tempHtml.replace(
          /```(\w+)?(\s*)([\s\S]*?)```/gi,
          function (match, lang, whitespace, content) {
            console.log("ğŸ”§ å¤„ç†ä»£ç å—ï¼Œè¯­è¨€:", lang || "æœªæŒ‡å®š");

            // æ™ºèƒ½è¯­è¨€æ£€æµ‹
            let actualLang = lang;
            if (lang && /^\d+$/.test(lang)) {
              console.log("ğŸ”§ æ£€æµ‹åˆ°çº¯æ•°å­—è¯­è¨€åï¼Œä½¿ç”¨è‡ªåŠ¨è¯†åˆ«:", lang);
              actualLang = '';
            }

            // æ¸…ç†å’Œä¿æŠ¤ä»£ç å†…å®¹
            let cleanContent = content
              .replace(/<\/div>\s*<div[^>]*>/gi, "\n")
              .replace(/<div[^>]*>/gi, "\n")
              .replace(/<\/div>/gi, "")
              .replace(/&nbsp;/gi, " ");

            // ç§»é™¤å¯Œæ–‡æœ¬æ ‡ç­¾ä½†ä¿ç•™ä»£ç ä¸­çš„ HTML
            const richTextTags = ['p', 'span', 'font', 'strong', 'b', 'em', 'i', 'u', 'div', 'br'];
            richTextTags.forEach(tag => {
              const regex = new RegExp(`</?${tag}(?:\\s[^>]*)?>`, 'gi');
              cleanContent = cleanContent.replace(regex, '');
            });

            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œä½†ä¿ç•™æ ¼å¼
            cleanContent = cleanContent
              .replace(/\n{3,}/g, "\n\n")
              .trim();

            const placeholder = `__CODE_BLOCK_${codeBlockPlaceholders.length}__`;
            const finalCodeBlock = "```" + (actualLang || "") + "\n" + cleanContent + "\n```";
            codeBlockPlaceholders.push(finalCodeBlock);
            
            console.log("âœ… ä»£ç å—å¤„ç†å®Œæˆ");
            return placeholder;
          }
        );

        // ä¿æŠ¤ Svelte è¡¨è¾¾å¼
        const sveltePlaceholders = [];
        tempHtml = tempHtml.replace(/(<script[\s\S]*?<\/script>)|({[^}]*(?:(?:&&|\|\||[+\-*/%]|\?|:|\|\>|\|\<|\|\=|\&\>|\&\<|\&\=|=>|==|!=|>=|<=|\+=|-=|\*=|\/=|%=|\?\.|\?\?|[|&]|\s+or\s+|\s+and\s+)[^}]*)+}|{#[\s\S]*?}|{:[\s\S]*?}|{\/[\s\S]*?})/gi, function(match, script, expr) {
          const placeholder = `__SVELTE_EXPR_${sveltePlaceholders.length}__`;
          sveltePlaceholders.push(match);
          console.log("ğŸ¯ ä¿æŠ¤ Svelte è¡¨è¾¾å¼:", match);
          return placeholder;
        });

        // ğŸ–¼ï¸ åˆ†åˆ«ä¿æŠ¤å›¾ç‰‡ã€éŸ³é¢‘ã€è¡¨æ ¼ã€åˆ—è¡¨å’Œå†…è”æ ·å¼ç­‰å†…å®¹
        const imgPlaceholders = [];
        const soundPlaceholders = [];
        const tablePlaceholders = [];
        const listPlaceholders = [];
        const inlineStylePlaceholders = [];

        // ä¿æŠ¤ <img> æ ‡ç­¾
        tempHtml = tempHtml.replace(/<img[^>]*>/gi, function (match) {
          const placeholder = `__IMG_PLACEHOLDER_${imgPlaceholders.length}__`;
          imgPlaceholders.push(match);
          return placeholder;
        });

        // ä¿æŠ¤éŸ³é¢‘æ–‡ä»¶å¼•ç”¨
        tempHtml = tempHtml.replace(/\[sound:[^\]]+\]/gi, function (match) {
          const placeholder = `__SOUND_PLACEHOLDER_${soundPlaceholders.length}__`;
          soundPlaceholders.push(match);
          return placeholder;
        });

        // ğŸ”§ ä¿æŠ¤HTMLè¡¨æ ¼ç»“æ„
        tempHtml = tempHtml.replace(
          /<table[\s\S]*?<\/table>/gi,
          function (match) {
            const placeholder = `__TABLE_PLACEHOLDER_${tablePlaceholders.length}__`;
            tablePlaceholders.push(match);
            console.log("ğŸ ä¿æŠ¤è¡¨æ ¼ç»“æ„:", placeholder);
            return placeholder;
          }
        );

        // ğŸ“ ä¿æŠ¤HTMLåˆ—è¡¨ç»“æ„ï¼ˆåŒ…æ‹¬åµŒå¥—åˆ—è¡¨ï¼‰
        tempHtml = tempHtml.replace(
          /<[ou]l[\s\S]*?<\/[ou]l>/gi,
          function (match) {
            const placeholder = `__LIST_PLACEHOLDER_${listPlaceholders.length}__`;
            listPlaceholders.push(match);
            console.log("ğŸ“ ä¿æŠ¤åˆ—è¡¨ç»“æ„:", placeholder);
            return placeholder;
          }
        );

        // ğŸ¨ ä¿æŠ¤å¸¸ç”¨å†…è”æ ·å¼æ ‡ç­¾
        const inlineStyleTags = [
          /<span[^>]*style[^>]*>[\s\S]*?<\/span>/gi, // <span style="...">
          /<font[^>]*(?:color|size|face)[^>]*>[\s\S]*?<\/font>/gi, // <font color/size/face="...">
          /<mark[^>]*>[\s\S]*?<\/mark>/gi, // <mark>
          /<small[^>]*>[\s\S]*?<\/small>/gi, // <small>
          /<big[^>]*>[\s\S]*?<\/big>/gi, // <big>
          /<sup[^>]*>[\s\S]*?<\/sup>/gi, // <sup>
          /<sub[^>]*>[\s\S]*?<\/sub>/gi, // <sub>
          /<del[^>]*>[\s\S]*?<\/del>/gi, // <del>
          /<strike[^>]*>[\s\S]*?<\/strike>/gi, // <strike>
          /<s[^>]*>[\s\S]*?<\/s>/gi, //  
        ];

        inlineStyleTags.forEach((regex) => {
          tempHtml = tempHtml.replace(regex, function (match) {
            const placeholder = `__INLINE_STYLE_${inlineStylePlaceholders.length}__`;
            inlineStylePlaceholders.push(match);
            console.log(
              "ğŸ¨ ä¿æŠ¤å†…è”æ ·å¼:",
              placeholder,
              match.substring(0, 50) + "..."
            );
            return placeholder;
          });
        });

        // ğŸ§¹ æ™ºèƒ½HTMLæ¸…ç†å’ŒMarkdownè½¬æ¢
        let cleaned = tempHtml
          // ç‰¹æ®Šå¤„ç†ï¼šæ¸…ç†è¿ç»­çš„divæ ‡ç­¾ï¼ˆAnkiå¸¸è§æ ¼å¼ï¼‰
          .replace(/<\/div>\s*<div[^>]*>/gi, "\n")
          .replace(/<\/div>/gi, "\n")
          .replace(/<div[^>]*>/gi, "\n")
          // ä¿æŒ Svelte è¯­æ³•å®Œæ•´æ€§
          .replace(/=\s*"\s*{/g, '={')  // ä¿®å¤ ="{ ä¸º ={
          .replace(/}\s*"/g, '}')       // ä¿®å¤ }" ä¸º }
          // ğŸ”§ æ­£ç¡®å¤„ç†å¯Œæ–‡æœ¬æ ‡ç­¾è½¬æ¢ä¸ºMarkdown
          .replace(/<strong[^>]*>(.*?)<\/strong>/gi, "**$1**") // <strong>text</strong> â†’ **text**
          .replace(/<b[^>]*>(.*?)<\/b>/gi, "**$1**") // <b>text</b> â†’ **text**
          .replace(/<em[^>]*>(.*?)<\/em>/gi, "*$1*") // <em>text</em> â†’ *text*
          .replace(/<i[^>]*>(.*?)<\/i>/gi, "*$1*") // <i>text</i> â†’ *text*
          .replace(/<u[^>]*>(.*?)<\/u>/gi, "$1") // ç§»é™¤ä¸‹åˆ’çº¿æ ‡ç­¾ä½†ä¿ç•™å†…å®¹
          // ğŸ”§ å¤„ç†æ ‡é¢˜æ ‡ç­¾
          .replace(
            /<h([1-6])[^>]*>(.*?)<\/h\1>/gi,
            function (match, level, text) {
              return "#".repeat(parseInt(level)) + " " + text + "\n";
            }
          )
          // ğŸ”§ å¤„ç†é“¾æ¥æ ‡ç­¾
          .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, "[$2]($1)")
          // ğŸ“ åˆ—è¡¨æ ‡ç­¾å·²è¢«ä¿æŠ¤ï¼Œä¸å†è¿›è¡Œè½¬æ¢
          // æ¸…ç†å…¶ä»–HTMLæ ‡ç­¾
          .replace(/<br\s*\/?>/gi, "\n")
          .replace(/<p[^>]*>/gi, "\n")
          .replace(/<\/p>/gi, "\n")
          .replace(/<span[^>]*>/gi, "")
          .replace(/<\/span>/gi, "")
          .replace(/<code[^>]*>/gi, "`")
          .replace(/<\/code>/gi, "`")
          .replace(/<pre[^>]*>/gi, "")
          .replace(/<\/pre>/gi, "")
          // ğŸ¨ æ¸…ç†ä»»ä½•å‰©ä½™çš„HTMLæ ‡ç­¾ï¼ˆå†…è”æ ·å¼å·²è¢«ä¿æŠ¤ï¼Œä¸ä¼šè¢«æ¸…ç†ï¼‰
          .replace(/<[^>]*>/gi, "")
          // æ¸…ç†å¤šä½™çš„Markdownæ ¼å¼é‡å¤
          .replace(/\*{3,}/g, "**") // ***+ â†’ **
          .replace(/\*\*\s*\*\*/g, "") // ** ** â†’ ç©º
          // æ¸…ç†å¤šä½™ç©ºè¡Œå’Œç©ºç™½
          .replace(/\n\s*\n\s*\n/g, "\n\n")
          .replace(/^\s+|\s+$/g, ""); // trim

        // ğŸ”§ ç‰¹æ®Šå¤„ç†è¡¨æ ¼ï¼šç§»é™¤è¡¨æ ¼è¡Œä¹‹é—´çš„ç©ºè¡Œ
        const lines = cleaned.split(/\r?\n/);
        const tableRowPattern = /^\s*\|.*\|\s*$/;
        let processedLines = [];

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i].trim();

          if (line) {
            processedLines.push(line);
          } else {
            // ç©ºè¡Œå¤„ç†ï¼šå¦‚æœå‰åéƒ½æ˜¯è¡¨æ ¼è¡Œï¼Œè·³è¿‡ç©ºè¡Œ
            const prevLine = processedLines[processedLines.length - 1];
            const nextLine = lines[i + 1]?.trim();

            if (
              !(
                tableRowPattern.test(prevLine) && tableRowPattern.test(nextLine)
              )
            ) {
              processedLines.push("");
            }
          }
        }

        let result = processedLines.join("\n");

        // ğŸ–¼ï¸ æ¢å¤ä¿æŠ¤çš„åª’ä½“å†…å®¹
        imgPlaceholders.forEach((original, index) => {
          const placeholder = `__IMG_PLACEHOLDER_${index}__`;
          result = result.replace(placeholder, original);
        });

        soundPlaceholders.forEach((original, index) => {
          const placeholder = `__SOUND_PLACEHOLDER_${index}__`;
          result = result.replace(placeholder, original);
        });

        // ğŸ æ¢å¤è¡¨æ ¼ç»“æ„
        tablePlaceholders.forEach((original, index) => {
          const placeholder = `__TABLE_PLACEHOLDER_${index}__`;
          result = result.replace(placeholder, original);
          console.log("ğŸ æ¢å¤è¡¨æ ¼ç»“æ„:", placeholder);
        });

        // ğŸ“ æ¢å¤åˆ—è¡¨ç»“æ„
        listPlaceholders.forEach((original, index) => {
          const placeholder = `__LIST_PLACEHOLDER_${index}__`;
          result = result.replace(placeholder, original);
          console.log("ğŸ“ æ¢å¤åˆ—è¡¨ç»“æ„:", placeholder);
        });

        // ğŸ¨ æ¢å¤å†…è”æ ·å¼
        inlineStylePlaceholders.forEach((original, index) => {
          const placeholder = `__INLINE_STYLE_${index}__`;
          result = result.replace(placeholder, original);
          console.log(
            "ğŸ¨ æ¢å¤å†…è”æ ·å¼:",
            placeholder,
            original.substring(0, 50) + "..."
          );
        });

        // ğŸ’» æ¢å¤Markdownä»£ç å—
        codeBlockPlaceholders.forEach((original, index) => {
          const placeholder = `__CODE_BLOCK_${index}__`;
          console.log("ğŸ” [DEBUG] æ¢å¤ä»£ç å—", index, "å ä½ç¬¦:", placeholder);
          console.log("ğŸ” [DEBUG] æ¢å¤ä»£ç å—", index, "å†…å®¹:", original.substring(0, 100) + (original.length > 100 ? "..." : ""));
          result = result.replace(placeholder, original);
        });

        // æ¢å¤ Svelte è¡¨è¾¾å¼
        sveltePlaceholders.forEach((original, index) => {
          const placeholder = `__SVELTE_EXPR_${index}__`;
          result = result.replace(placeholder, original);
          console.log("ğŸ¯ æ¢å¤ Svelte è¡¨è¾¾å¼:", original);
        });

        console.log("âœ… HTMLæ¸…ç†å®Œæˆ");
        console.log("ğŸ” [DEBUG] cleanHTMLæœ€ç»ˆè¾“å‡º:", result.substring(0, 300) + (result.length > 300 ? "..." : ""));
        return result;
      }

      // ğŸ”’ å®‰å…¨çš„HTMLè½¬ä¹‰å‡½æ•°
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ğŸ”’ å®‰å…¨åœ°è®¾ç½®HTMLå†…å®¹ï¼ˆé˜²æ­¢è„šæœ¬æ‰§è¡Œï¼‰
      function safeSetHTML(element, htmlContent) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨
        const temp = document.createElement("div");
        temp.innerHTML = htmlContent;

        // ç§»é™¤æ‰€æœ‰å¯èƒ½æ‰§è¡Œçš„è„šæœ¬æ ‡ç­¾å’Œäº‹ä»¶å¤„ç†å™¨
        const scripts = temp.querySelectorAll("script");
        scripts.forEach((script) => {
          console.log("ğŸš¨ ç§»é™¤scriptæ ‡ç­¾:", script.outerHTML.substring(0, 100));
          script.remove();
        });

        // ç§»é™¤æ‰€æœ‰äº‹ä»¶å±æ€§å’Œå±é™©å…ƒç´ 
        const allElements = temp.querySelectorAll("*");
        allElements.forEach((el) => {
          // ç§»é™¤æ‰€æœ‰ä»¥ 'on' å¼€å¤´çš„å±æ€§ï¼ˆå¦‚ onclick, onload ç­‰ï¼‰
          Array.from(el.attributes).forEach((attr) => {
            if (attr.name.toLowerCase().startsWith("on")) {
              console.log("ğŸš¨ ç§»é™¤äº‹ä»¶å±æ€§:", attr.name, "from", el.tagName);
              el.removeAttribute(attr.name);
            }
          });

          // ç§»é™¤ javascript: é“¾æ¥
          if (el.href && el.href.toLowerCase().startsWith("javascript:")) {
            console.log("ğŸš¨ ç§»é™¤javascripté“¾æ¥:", el.href);
            el.removeAttribute("href");
          }
          if (el.src && el.src.toLowerCase().startsWith("javascript:")) {
            console.log("ğŸš¨ ç§»é™¤javascriptæº:", el.src);
            el.removeAttribute("src");
          }

          // ğŸ”’ é¢å¤–å®‰å…¨æ£€æŸ¥ï¼šç§»é™¤æ½œåœ¨å±é™©çš„æ ‡ç­¾
          const dangerousTags = [
            "iframe",
            "object",
            "embed",
            "link",
            "meta",
            "base",
          ];
          if (dangerousTags.includes(el.tagName.toLowerCase())) {
            console.log("ğŸš¨ ç§»é™¤å±é™©æ ‡ç­¾:", el.tagName);
            el.remove();
          }
        });

        // ğŸ”’ æ™ºèƒ½å®‰å…¨æ£€æŸ¥ï¼šåªæ£€æŸ¥ä»£ç å—å¤–çš„scriptæ ‡ç­¾
        const finalHTML = temp.innerHTML;

        // åˆ›å»ºä¸´æ—¶å®¹å™¨æ£€æŸ¥ä»£ç å—å¤–çš„å†…å®¹
        const checkDiv = document.createElement("div");
        checkDiv.innerHTML = finalHTML;

        // ç§»é™¤æ‰€æœ‰ä»£ç å—ï¼ˆè¿™äº›æ˜¯å®‰å…¨çš„æ–‡æœ¬å†…å®¹ï¼‰
        const safeCodeBlocks = checkDiv.querySelectorAll("pre code, pre, code");
        safeCodeBlocks.forEach((block) => block.remove());

        // æ£€æŸ¥å‰©ä½™å†…å®¹æ˜¯å¦æœ‰å±é™©çš„scriptæ ‡ç­¾
        const remainingContent = checkDiv.innerHTML;
        if (remainingContent.toLowerCase().includes("<script")) {
          console.error("ğŸš¨ æ£€æµ‹åˆ°ä»£ç å—å¤–çš„scriptæ ‡ç­¾ï¼Œæ‹’ç»è®¾ç½®HTML");
          element.innerHTML =
            '<p style="color: red;">âš ï¸ å†…å®¹åŒ…å«å¯æ‰§è¡Œè„šæœ¬ï¼Œå·²è¢«é˜»æ­¢</p>';
          return;
        }

        console.log("âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼Œä»£ç å—ä¸­çš„scriptæ ‡ç­¾è¢«è§†ä¸ºå®‰å…¨æ–‡æœ¬");

        // ğŸ”’ ç®€åŒ–å®‰å…¨æ£€æŸ¥ï¼šåªæ£€æŸ¥çœŸæ­£å±é™©çš„å¯æ‰§è¡Œæ ‡ç­¾
        const codeElements = temp.querySelectorAll("pre code");
        codeElements.forEach((code, index) => {
          const innerHTML = code.innerHTML;
          const textContent = code.textContent || code.innerText || "";

          // åªæ£€æŸ¥çœŸæ­£å¯æ‰§è¡Œçš„å±é™©æ ‡ç­¾
          const executablePattern = /<(?:script|iframe|object|embed|form)\s[^>]*>/i;

          if (executablePattern.test(innerHTML)) {
            console.log(
              `ğŸš¨ ä»£ç å— ${index} åŒ…å«å¯æ‰§è¡ŒHTMLï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºæ–‡æœ¬`
            );
            const originalClassName = code.className;
            code.textContent = textContent;
            if (originalClassName) {
              code.className = originalClassName;
            }
          } else {
            console.log(`âœ… ä»£ç å— ${index} å®‰å…¨ï¼Œä¿æŒæ­£å¸¸æ˜¾ç¤º`);
          }
        });

        // å®‰å…¨åœ°è®¾ç½®å†…å®¹
        const safeHTML = temp.innerHTML;
        console.log("ğŸ” [DEBUG] safeSetHTMLæœ€ç»ˆè¾“å‡º:", safeHTML.substring(0, 300) + (safeHTML.length > 300 ? "..." : ""));
        element.innerHTML = safeHTML;
        console.log("âœ… HTMLå†…å®¹å·²å®‰å…¨è®¾ç½®");
      }

      // ğŸ·ï¸ ä»£ç å—å¤„ç†å’Œå®‰å…¨åŒ–å‡½æ•°
      function addCodeHighlight(container) {
        const codeBlocks = container.querySelectorAll("pre code");
        if (codeBlocks.length === 0) return;

        console.log(`ğŸ·ï¸ ä¸º ${codeBlocks.length} ä¸ªä»£ç å—æ·»åŠ è¯­è¨€æ ‡ç­¾`);

        codeBlocks.forEach((block, index) => {
          try {
            console.log(`ğŸ·ï¸ å¤„ç†ä»£ç å— ${index} è¯­è¨€æ ‡ç­¾`);

            // ğŸš€ è·å–è¯­è¨€ä¿¡æ¯
            let finalLanguage = "text";

            // ä»CSSç±»åè·å–è¯­è¨€
            if (block.className) {
              const match = block.className.match(/language-(\w+)/);
              if (match) {
                finalLanguage = match[1];
                console.log(`ğŸ“ ä»ç±»åè·å–è¯­è¨€: ${finalLanguage}`);
              }
            }

            // ä»markdown-itç”Ÿæˆçš„æ³¨é‡Šä¸­æå–è¯­è¨€ä¿¡æ¯
            const htmlContent = block.innerHTML;
            if (htmlContent.includes("<!-- lang:")) {
              const start = htmlContent.indexOf("<!-- lang:") + 10;
              const end = htmlContent.indexOf(" -->", start);
              if (end > start) {
                finalLanguage = htmlContent.substring(start, end);
                // ç§»é™¤è¯­è¨€æ³¨é‡Š
                block.innerHTML = htmlContent.replace(/<!-- lang:\w+ -->/, "");
                console.log(`ğŸ“ ä»æ³¨é‡Šè·å–è¯­è¨€: ${finalLanguage}`);
              }
            }

            // ğŸ”§ è¿‡æ»¤çº¯æ•°å­—è¯­è¨€åï¼Œå¦‚æœæ˜¯æ•°å­—å°±ä½¿ç”¨è‡ªåŠ¨è¯†åˆ«
            if (finalLanguage && /^\d+$/.test(finalLanguage)) {
              console.log("ğŸ”§ æ£€æµ‹åˆ°çº¯æ•°å­—è¯­è¨€åï¼Œä½¿ç”¨è‡ªåŠ¨è¯†åˆ«:", finalLanguage);
              finalLanguage = "auto";
            }

            // æ·»åŠ è¯­è¨€æ ‡è¯†ç¬¦ - å®‰å…¨æ£€æŸ¥
            const preElement = block.parentElement;
            if (preElement && preElement.tagName === "PRE") {
              addLanguageLabel(preElement, finalLanguage);
              console.log(`âœ… å·²ä¸ºä»£ç å— ${index} æ·»åŠ  ${finalLanguage} æ ‡ç­¾`);
              console.log(`ğŸ” [DEBUG] ä»£ç å— ${index} æœ€ç»ˆå†…å®¹:`, block.innerHTML.substring(0, 100) + (block.innerHTML.length > 100 ? "..." : ""));
              console.log(`ğŸ” [DEBUG] ä»£ç å— ${index} æ–‡æœ¬å†…å®¹:`, block.textContent.substring(0, 100) + (block.textContent.length > 100 ? "..." : ""));
            } else {
              console.warn("âš ï¸ æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„preå…ƒç´ ï¼Œè·³è¿‡è¯­è¨€æ ‡ç­¾æ·»åŠ ");
            }
          } catch (error) {
            console.warn(`âš ï¸ æ·»åŠ ä»£ç å—æ ‡ç­¾å¤±è´¥:`, error.message);
            if (block.parentElement) {
              addLanguageLabel(block.parentElement, "text");
            }
          }
        });
      }

      // å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
      async function copyToClipboard(text, button) {
        const originalText = button.textContent;

        try {
          await navigator.clipboard.writeText(text);

          // è§†è§‰åé¦ˆ
          button.classList.add("copied");
          button.textContent = "å·²å¤åˆ¶";

          setTimeout(() => {
            button.classList.remove("copied");
            button.textContent = originalText;
          }, 1000);

          console.log("ğŸ“‹ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        } catch (err) {
          // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„ execCommand
          try {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);

            // åŒæ ·çš„è§†è§‰åé¦ˆ
            button.classList.add("copied");
            button.textContent = "å·²å¤åˆ¶";

            setTimeout(() => {
              button.classList.remove("copied");
              button.textContent = originalText;
            }, 1000);

            console.log("ğŸ“‹ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (fallback)");
          } catch (fallbackErr) {
            console.warn("âŒ å¤åˆ¶å¤±è´¥:", fallbackErr);
            button.textContent = "å¤åˆ¶å¤±è´¥";
            setTimeout(() => {
              button.textContent = originalText;
            }, 1000);
          }
        }
      }

      // æ·»åŠ è¯­è¨€æ ‡è¯†ç¬¦å‡½æ•°
      function addLanguageLabel(preElement, language) {
        // ğŸ”’ å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿preElementå­˜åœ¨ä¸”æœ‰parentElement
        if (!preElement || !preElement.parentElement) {
          console.warn(
            "âš ï¸ preElementæˆ–å…¶parentElementä¸ºnullï¼Œè·³è¿‡è¯­è¨€æ ‡ç­¾æ·»åŠ "
          );
          return;
        }

        // æ£€æŸ¥preå…ƒç´ æ˜¯å¦å·²ç»è¢«åŒ…è£…
        let wrapper = preElement.parentElement;
        if (!wrapper.classList.contains("code-wrapper")) {
          // åˆ›å»ºåŒ…è£…å®¹å™¨
          wrapper = document.createElement("div");
          wrapper.className = "code-wrapper";
          wrapper.style.position = "relative";
          wrapper.style.display = "block";

          // å°†preå…ƒç´ åŒ…è£…èµ·æ¥
          preElement.parentNode.insertBefore(wrapper, preElement);
          wrapper.appendChild(preElement);
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ ‡ç­¾
        const existingLabel = wrapper.querySelector(".code-lang-label");
        if (existingLabel) {
          existingLabel.remove();
        }

        // åˆ›å»ºè¯­è¨€æ ‡ç­¾
        const langLabel = document.createElement("div");
        langLabel.className = "code-lang-label";
        langLabel.textContent = language;
        langLabel.title = "ç‚¹å‡»å¤åˆ¶ä»£ç ";

        // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
        langLabel.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();

          // è·å–ä»£ç å—å†…å®¹
          const codeElement = preElement.querySelector("code");
          if (codeElement) {
            const codeText =
              codeElement.textContent || codeElement.innerText || "";
            await copyToClipboard(codeText, langLabel);
          }
        });

        // æ·»åŠ åˆ°åŒ…è£…å®¹å™¨è€Œä¸æ˜¯preå…ƒç´ 
        wrapper.appendChild(langLabel);
      }

      function renderMarkdown(ID) {
        const el = document.getElementById(ID);
        if (!el || el.dataset.markdownProcessed === "true") return;

        // è·å–åŸå§‹å†…å®¹
        const original = el.innerHTML;

        // åˆ›å»ºå®‰å…¨çš„markdown-itå®ä¾‹
        const md = window.markdownit({
          html: true,
          breaks: true,
          typographer: true,
          linkify: true,
          highlight: function (str, lang) {
            if (typeof str !== "string") return str || "";

            console.log(
              "ğŸ¯ ä»£ç å—å¤„ç†ï¼Œè¯­è¨€:",
              lang || "æœªæŒ‡å®š",
              "åŸå§‹å†…å®¹:",
              str.substring(0, 50)
            );

            // å¦‚æœæ˜¯ mermaid å›¾è¡¨
            if (lang === 'mermaid') {
              return `<div class="mermaid">${str}</div>`;
            }

            // ğŸ”§ æ™ºèƒ½è¯­è¨€æ£€æµ‹ï¼šé¿å…æŠŠè¡Œå·å½“ä½œè¯­è¨€å
            let actualLang = lang;
            if (lang && /^\d+$/.test(lang)) {
              // å¦‚æœè¯­è¨€åæ˜¯çº¯æ•°å­—ï¼Œä½¿ç”¨è‡ªåŠ¨è¯†åˆ«
              console.log("ğŸ”§ æ£€æµ‹åˆ°çº¯æ•°å­—è¯­è¨€åï¼Œä½¿ç”¨è‡ªåŠ¨è¯†åˆ«:", lang);
              actualLang = '';
            }

            // ğŸ”’ æ™ºèƒ½HTMLè½¬ä¹‰ï¼šè®©HTMLä»£ç æ­£å¸¸æ˜¾ç¤ºï¼Œä½†ç¡®ä¿å®‰å…¨
            const smartEscapeHtml = (text, language) => {
              // ğŸ”§ ä¿®å¤ï¼šå¯¹äºä»£ç å—ä¸­çš„HTMLï¼Œæˆ‘ä»¬ä¸åº”è¯¥è½¬ä¹‰ï¼Œåº”è¯¥è®©å®ƒæ˜¾ç¤ºä¸ºåŸå§‹æ–‡æœ¬
              // ä»£ç å—æœ¬èº«å°±æ˜¯å®‰å…¨çš„æ–‡æœ¬å†…å®¹ï¼Œä¸éœ€è¦é¢å¤–çš„HTMLè½¬ä¹‰
              console.log("âœ… ä»£ç å—å†…å®¹æ­£å¸¸æ˜¾ç¤ºï¼Œæ— éœ€è½¬ä¹‰");
              console.log("ğŸ” [DEBUG] smartEscapeè¾“å…¥:", text.substring(0, 100) + (text.length > 100 ? "..." : ""));
              console.log("ğŸ” [DEBUG] smartEscapeè¾“å‡º:", text.substring(0, 100) + (text.length > 100 ? "..." : ""));
              return text;
            };

            const processedStr = smartEscapeHtml(str, actualLang);
            let highlightedCode = "";

            if (actualLang && window.hljs) {
              try {
                const result = window.hljs.highlight(processedStr, {
                  language: actualLang,
                });
                highlightedCode = result.value;
                console.log("âœ… ä½¿ç”¨æŒ‡å®šè¯­è¨€é«˜äº®:", actualLang);
              } catch (e) {
                console.warn("âŒ æŒ‡å®šè¯­è¨€é«˜äº®å¤±è´¥ï¼Œå›é€€åˆ°è‡ªåŠ¨æ£€æµ‹:", e.message);
                try {
                  const result = window.hljs.highlightAuto(processedStr);
                  highlightedCode = result.value;
                } catch (e2) {
                  console.warn("âŒ è‡ªåŠ¨æ£€æµ‹ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ä»£ç :", e2.message);
                  highlightedCode = processedStr;
                }
              }
            } else if (window.hljs) {
              try {
                const result = window.hljs.highlightAuto(processedStr);
                highlightedCode = result.value;
                console.log("âœ… è‡ªåŠ¨æ£€æµ‹è¯­è¨€é«˜äº®:", result.language || "auto");
              } catch (e) {
                console.warn("âŒ è‡ªåŠ¨é«˜äº®å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ä»£ç :", e.message);
                highlightedCode = processedStr;
              }
            } else {
              highlightedCode = processedStr;
              console.log("âœ… hljsæœªåŠ è½½ï¼Œä½¿ç”¨å¤„ç†åä»£ç ");
            }

            console.log("âœ… è¿”å›å¤„ç†åä»£ç ï¼Œé•¿åº¦:", highlightedCode.length);
            console.log("ğŸ” [DEBUG] highlightå‡½æ•°è¾“å‡ºå†…å®¹:", highlightedCode.substring(0, 100) + (highlightedCode.length > 100 ? '...' : ''));
            return highlightedCode;
          },
        });

        if (window.markdownItMark) md.use(window.markdownItMark);

        try {
          const text = cleanHTML(original);
          console.log(`ğŸ”„ å¼€å§‹æ¸²æŸ“Markdownå†…å®¹ï¼Œé•¿åº¦: ${text.length}`);

          const rendered = md.render(text);
          console.log(`âœ… Markdownæ¸²æŸ“å®Œæˆï¼Œé•¿åº¦: ${rendered.length}`);

          // ğŸ”’ ä½¿ç”¨å®‰å…¨çš„æ–¹å¼è®¾ç½®HTMLå†…å®¹
          safeSetHTML(el, rendered);
          el.dataset.markdownProcessed = "true";

          // âœ… å®‰å…¨çš„ä»£ç é«˜äº®åŠŸèƒ½
          addCodeHighlight(el);

          // åˆå§‹åŒ– Mermaid å›¾è¡¨
          if (window.mermaid) {
            try {
              window.mermaid.initialize({
                startOnLoad: false,
                theme: document.body.classList.contains('nightMode') ? 'dark' : 'default',
                securityLevel: 'strict'
              });
              
              const mermaidDiagrams = el.querySelectorAll('.mermaid');
              mermaidDiagrams.forEach(async (diagram) => {
                try {
                  const graphDefinition = diagram.textContent;
                  const { svg } = await window.mermaid.render('mermaid-' + Math.random(), graphDefinition);
                  diagram.innerHTML = svg;
                } catch (err) {
                  console.warn('âŒ Mermaid å›¾è¡¨æ¸²æŸ“å¤±è´¥:', err);
                  diagram.innerHTML = `<div class="error-message">âŒ å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${escapeHtml(err.message)}</div>`;
                }
              });
            } catch (err) {
              console.warn('âŒ Mermaid åˆå§‹åŒ–å¤±è´¥:', err);
            }
          }

          console.log(
            `ğŸ‰ ${ID} æ¸²æŸ“å®Œæˆï¼ŒåŒ…å«ä»£ç å—: ${el.querySelectorAll("pre code").length}ä¸ª`
          );
        } catch (error) {
          console.error(`âŒ æ¸²æŸ“å¤±è´¥ ${ID}:`, error.message, error.stack);
          // å®‰å…¨å›é€€ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯è€Œä¸æ˜¯å¯èƒ½çš„æ¶æ„å†…å®¹
          el.innerHTML = `<div class="error-message">âŒ å†…å®¹æ¸²æŸ“å¤±è´¥: ${escapeHtml(
            error.message
          )}</div>`;
        }
      }

      function renderMath(ID) {
        const el = document.getElementById(ID);
        if (
          !el ||
          el.dataset.katexRendered === "true" ||
          !window.renderMathInElement
        )
          return;
        renderMathInElement(el, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false},
          ],
          throwOnError: false,
          macros: {
            "\\ce": "\\ce",
          },
        });
        el.dataset.katexRendered = "true";
      }

      function renderAll() {
        console.log("ğŸ¯ å¼€å§‹æ¸²æŸ“æ‰€æœ‰å…ƒç´ ");
        ["front", "back"].forEach((id) => {
          renderMarkdown(id);
          renderMath(id);
        });
      }

      async function init() {
        try {
          console.log("âœ… å¼€å§‹åˆå§‹åŒ–");

          console.log("âœ… é¢„è§ˆæ¨¡å¼ï¼Œå¯ç”¨Markdownæ¸²æŸ“å™¨");
          
          // æ ¹æ®å½“å‰æ¨¡å¼åŠ è½½å¯¹åº”çš„ highlight.js ä¸»é¢˜
          const isDarkMode = document.body.classList.contains('nightMode');
          const highlightTheme = isDarkMode ? 'github-dark' : 'github';
          
          // åŠ¨æ€åŠ è½½ä¸»é¢˜ CSS
          const themeLink = document.createElement('link');
          themeLink.rel = 'stylesheet';
          themeLink.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.0/styles/${highlightTheme}.min.css`;
          document.head.appendChild(themeLink);
          
          // åŠ è½½å…¶ä»–èµ„æº
          await Promise.all([
            ...RESOURCES.css.filter(css => !css[0].includes('highlight')).map(loadCSS),
            ...RESOURCES.scripts.map(loadScript),
          ]);
          
          // âœ¨ æ‰‹åŠ¨æ³¨å†ŒSvelteè¯­è¨€æ”¯æŒï¼ˆæ°¸ä¹…æ–¹æ¡ˆï¼‰
          if (window.hljs && !window.hljs.getLanguage("svelte")) {
            console.log("ğŸ”§ æ³¨å†ŒSvelteè¯­è¨€å®šä¹‰");
            window.hljs.registerLanguage("svelte", function (hljs) {
              return {
                name: "Svelte",
                aliases: ["svelte"],
                case_insensitive: false,
                subLanguage: "xml",
                contains: [
                  // Svelteè¡¨è¾¾å¼ {expression}
                  {
                    className: "template-variable",
                    begin: /\{/,
                    end: /\}/,
                    excludeBegin: true,
                    excludeEnd: true,
                    contains: [
                      {
                        subLanguage: "javascript",
                        begin: /[^}]+/,
                      },
                    ],
                  },
                  // SvelteæŒ‡ä»¤ {#if} {#each} etc
                  {
                    className: "template-tag",
                    begin: /\{[#:/]/,
                    end: /\}/,
                    contains: [
                      {
                        className: "name",
                        begin: /[#:/]\w+/,
                      },
                      {
                        subLanguage: "javascript",
                        begin: /\s+/,
                        end: /$/,
                      },
                    ],
                  },
                  // HTMLæ³¨é‡Š
                  hljs.COMMENT("<!--", "-->", {
                    relevance: 10,
                  }),
                  // HTMLæ ‡ç­¾
                  {
                    className: "tag",
                    begin: /<\/?[A-Za-z_]/,
                    end: />/,
                    contains: [
                      {
                        className: "name",
                        begin: /[A-Za-z_][\w:]*/,
                      },
                      {
                        className: "attr",
                        begin: /\s[A-Za-z_][\w:]*(?=\s*=)/,
                      },
                      {
                        begin: /=/,
                        end: /$/,
                        contains: [
                          hljs.APOS_STRING_MODE,
                          hljs.QUOTE_STRING_MODE,
                          {
                            className: "template-variable",
                            begin: /\{/,
                            end: /\}/,
                            subLanguage: "javascript",
                          },
                        ],
                      },
                    ],
                  },
                ],
              };
            });

            // éªŒè¯æ³¨å†Œå¹¶è®°å½•çŠ¶æ€
            if (window.hljs.getLanguage("svelte")) {
              window.resourceStatus = window.resourceStatus || {};
              window.resourceStatus["svelte.js"] = "ğŸ”§ æ‰‹åŠ¨æ³¨å†Œ";
              console.log("âœ… Svelteè¯­è¨€æ³¨å†ŒæˆåŠŸï¼Œç°åœ¨å¯ç”¨ï¼");
            } else {
              window.resourceStatus = window.resourceStatus || {};
              window.resourceStatus["svelte.js"] = "âŒ æ³¨å†Œå¤±è´¥";
              console.log("âŒ Svelteè¯­è¨€æ³¨å†Œå¤±è´¥");
            }
          } else if (window.hljs?.getLanguage?.("svelte")) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus["svelte.js"] = "âœ… å·²å­˜åœ¨";
            console.log("âœ… Svelteè¯­è¨€å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ³¨å†Œ");
          } else {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus["svelte.js"] = "âŒ hljsæœªåŠ è½½";
            console.log("âŒ highlight.jsæœªåŠ è½½ï¼Œæ— æ³•æ³¨å†ŒSvelteè¯­è¨€");
          }

          // æ˜¾ç¤ºèµ„æºåŠ è½½çŠ¶æ€
          if (window.resourceStatus) {
            console.log("ğŸ“¦ èµ„æºåŠ è½½çŠ¶æ€:");
            Object.entries(window.resourceStatus).forEach(
              ([resource, status]) => {
                console.log(`   ${resource}: ${status}`);
              }
            );
          }

          renderAll();
          console.log("âœ… Markdownæ¸²æŸ“å™¨åˆå§‹åŒ–å®Œæˆ");
        } catch (e) {
          console.error("âŒ Initialization failed:", e);
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        setTimeout(init, 100);
      }
    })();
  }); // ç»“æŸ delayedEditModeCheck å›è°ƒ
</script>
