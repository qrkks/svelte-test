<style>
  /* ==============================================
     ç°ä»£åŒ– Anki ä»£ç é«˜äº®æ ·å¼
     ============================================== */
  
  /* CSS å˜é‡å®šä¹‰ */
  :root {
      --font-family-text: "Microsoft YaHei", "å¾®è½¯é›…é»‘", "Helvetica Neue", Arial, sans-serif;
      --font-family-code: "JetBrains Mono", "Fira Code", "Consolas", "Monaco", "Courier New", monospace;
      
      /* äº®è‰²ä¸»é¢˜ */
      --color-bg: #ffffff;
      --color-text: #1a1a1a;
      --color-code-bg: #f8f9fa;
      --color-code-border: #e9ecef;
      --color-code-text: #333333;
      --color-accent: #0066cc;
      --color-success: #10b981;
  }
  
  /* æš—è‰²ä¸»é¢˜ */
  .nightMode {
      --color-bg: #1e1e1e;
      --color-text: #e0e0e0;
      --color-code-bg: #2d2d2d;
      --color-code-border: #404040;
      --color-code-text: #e8e8e8;
      --color-accent: #4ade80;
      --color-success: #34d399;
  }
  
  /* å…¨å±€å­—ä½“ */
  #front, #back {
      font-family: var(--font-family-text);
      font-size: 20px;
      color: var(--color-text);
      background-color: var(--color-bg);
      line-height: 1.6;
  }
  
  /* ä»£ç å—å®¹å™¨ */
  .code-wrapper {
      position: relative;
      margin: 16px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: var(--color-code-bg);
      border: 1px solid var(--color-code-border);
  }
  
  /* é¢„æ ¼å¼åŒ–æ–‡æœ¬ */
  .code-wrapper pre {
      margin: 0;
      padding: 16px;
      background: transparent;
      border: none;
      overflow-x: auto;
      font-family: var(--font-family-code);
      font-size: 16px;
      line-height: 1.5;
  }
  
  /* ä»£ç å†…å®¹ */
  .code-wrapper code {
      font-family: inherit;
      background: transparent;
      padding: 0;
      border: none;
      color: var(--color-code-text);
      white-space: pre;
      word-wrap: normal;
  }
  
  /* è¯­è¨€æ ‡ç­¾ */
  .code-lang-label {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--color-success);
      color: white;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      text-transform: uppercase;
      font-family: var(--font-family-code);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      z-index: 10;
  }
  
  .code-lang-label:hover {
      background: var(--color-accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
  }
  
  .code-lang-label:active {
      transform: translateY(0);
  }
  
  .code-lang-label.copied {
      background: var(--color-success);
      animation: pulse 0.3s ease;
  }
  
  @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
  }
  
  /* è¡Œå†…ä»£ç  */
  :not(pre) > code {
      background: var(--color-code-bg);
      color: var(--color-code-text);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      font-family: var(--font-family-code);
      border: 1px solid var(--color-code-border);
  }
  
  /* å›¾ç‰‡æ ·å¼ */
  img {
      max-width: 100%;
      max-height: 80vh;
      height: auto;
      width: auto;
      display: block;
      margin: 16px auto;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      object-fit: contain;
  }
  
  /* é”™è¯¯æç¤º */
  .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      color: #dc2626;
      font-size: 14px;
  }
  
  .nightMode .error-message {
      background: #3d1a1a;
      border: 1px solid #8b2635;
      color: #ff6b6b;
  }
  
  /* æš—è‰²æ¨¡å¼é€‚é… */
  .nightMode img {
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
  }
  </style>
  
  
  <script>
  /* ==============================================
     ç°ä»£åŒ– Anki Markdown å¤„ç†å™¨ - é˜²é‡å¤ç‰ˆæœ¬
     ============================================== */
  
  // ğŸ”§ é˜²æ­¢é‡å¤æ‰§è¡Œçš„å®‰å…¨æœºåˆ¶
  (function() {
      'use strict';
      
      // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œç›´æ¥é€€å‡º
      if (window.ankiModernLoaded) {
          console.log('[Anki Modern] å·²åŠ è½½ï¼Œè·³è¿‡é‡å¤æ‰§è¡Œ');
          return;
      }
      
      window.ankiModernLoaded = true;
      console.log('[Anki Modern] å¼€å§‹åŠ è½½...');
      
      // åˆ›å»ºè°ƒè¯•é¢æ¿
      function createDebugPanel() {
          if (document.getElementById('debug-panel')) return;
          
          const debugPanel = document.createElement('div');
          debugPanel.id = 'debug-panel';
          debugPanel.style.cssText = `
              position: fixed;
              top: 10px;
              right: 10px;
              background: #000;
              color: #0f0;
              padding: 10px;
              border-radius: 5px;
              font-family: monospace;
              font-size: 12px;
              max-width: 300px;
              max-height: 200px;
              overflow-y: auto;
              z-index: 9999;
              border: 2px solid #0f0;
          `;
          debugPanel.innerHTML = '<div><strong>ğŸ”§ Anki Modern Debug</strong></div><div id="debug-log"></div>';
          document.body.appendChild(debugPanel);
      }
      
      // è°ƒè¯•æ—¥å¿—å‡½æ•°
      function debugLog(message, type = 'info') {
          const colors = { info: '#0f0', error: '#f00', warning: '#ff0', success: '#0f0' };
          console.log(`[Anki Modern] ${message}`);
          
          const debugLogElement = document.getElementById('debug-log');
          if (debugLogElement) {
              const logEntry = document.createElement('div');
              logEntry.style.color = colors[type] || '#0f0';
              logEntry.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
              debugLogElement.appendChild(logEntry);
              debugLogElement.scrollTop = debugLogElement.scrollHeight;
          }
      }
      
      // åˆ›å»ºæµ‹è¯•æŒ‰é’®
      function createTestButton() {
          if (document.querySelector('.anki-test-btn')) return;
          
          const testBtn = document.createElement('button');
          testBtn.className = 'anki-test-btn';
          testBtn.innerHTML = 'ğŸ§ª æµ‹è¯•';
          testBtn.style.cssText = `
              position: fixed;
              bottom: 10px;
              right: 10px;
              background: #007acc;
              color: white;
              border: none;
              padding: 10px;
              border-radius: 5px;
              cursor: pointer;
              z-index: 9999;
          `;
          
          testBtn.onclick = runTest;
          document.body.appendChild(testBtn);
      }
      
      // ç®€å•çš„æµ‹è¯•å‡½æ•°
      function runTest() {
          debugLog('ğŸ§ª å¼€å§‹æµ‹è¯•...', 'info');
          
          // åŸºç¡€æ£€æŸ¥
          debugLog(`Highlight.js: ${window.hljs ? 'âœ…' : 'âŒ'}`, window.hljs ? 'success' : 'error');
          debugLog(`Markdown-it: ${window.markdownit ? 'âœ…' : 'âŒ'}`, window.markdownit ? 'success' : 'error');
          debugLog(`KaTeX: ${window.katex ? 'âœ…' : 'âŒ'}`, window.katex ? 'success' : 'error');
          
          // å¦‚æœ markdown-it ä¸å­˜åœ¨ï¼Œç«‹å³å°è¯•åŠ è½½
          if (!window.markdownit) {
              debugLog('ğŸ”„ å°è¯•åŠ è½½ markdown-it...', 'warning');
              loadMarkdownIt();
          }
          
          // æµ‹è¯•å†…å®¹
          const frontEl = document.getElementById('front');
          if (frontEl) {
              frontEl.innerHTML = `
# æµ‹è¯•æ ‡é¢˜

è¿™æ˜¯**ç²—ä½“**å’Œ*æ–œä½“*æ–‡æœ¬ã€‚

\`\`\`javascript
function hello() {
    console.log("Hello World!");
}
\`\`\`

è¡Œå†…ä»£ç ï¼š\`console.log("test")\`
              `;
              debugLog('âœ… æµ‹è¯•å†…å®¹å·²æ’å…¥', 'success');
              
              // å¦‚æœ markdown-it å¯ç”¨ï¼Œç«‹å³å¤„ç†
              if (window.markdownit) {
                  processContent(frontEl);
              }
          }
      }
      
      // ğŸ”§ ä¿®å¤çš„èµ„æºåŠ è½½ - å¤šä¸ªCDNå¤‡é€‰æ–¹æ¡ˆ
      async function loadMarkdownIt() {
          console.log('ğŸ”„ å°è¯•åŠ è½½ markdown-it...');
          
          // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
          if (window.markdownit) {
              console.log('âœ… markdown-it å·²å­˜åœ¨');
              return;
          }
          
          console.log('ğŸ“¦ å¼€å§‹åŠ è½½ markdown-it...');
          
          // å¤šä¸ªå¤‡ç”¨CDNé“¾æ¥
          const cdnUrls = [
              'https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js',
              'https://unpkg.com/markdown-it@14.1.0/dist/markdown-it.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/markdown-it/14.1.0/markdown-it.min.js',
              'https://lib.baomitu.com/markdown-it/14.1.0/markdown-it.min.js'
          ];
          
          for (const url of cdnUrls) {
              try {
                  console.log(`ğŸ”— å°è¯•åŠ è½½: ${url}`);
                  
                  // å…ˆæ£€æŸ¥é“¾æ¥æ˜¯å¦å¯è®¿é—®
                  const testResponse = await fetch(url, { method: 'HEAD' }).catch(() => null);
                  if (!testResponse || !testResponse.ok) {
                      console.log(`âŒ é“¾æ¥ä¸å¯è®¿é—®: ${url}`);
                      continue;
                  }
                  
                  await new Promise((resolve, reject) => {
                      const script = document.createElement('script');
                      script.src = url;
                      
                      script.onload = () => {
                          // éªŒè¯æ˜¯å¦æ­£ç¡®åŠ è½½
                          if (window.markdownit && typeof window.markdownit === 'function') {
                              console.log(`âœ… markdown-it åŠ è½½æˆåŠŸ: ${url}`);
                              resolve();
                          } else {
                              console.log(`âŒ æ–‡ä»¶åŠ è½½ä½†åˆå§‹åŒ–å¤±è´¥: ${url}`);
                              reject(new Error('åˆå§‹åŒ–å¤±è´¥'));
                          }
                      };
                      
                      script.onerror = () => {
                          console.log(`âŒ è„šæœ¬åŠ è½½å¤±è´¥: ${url}`);
                          reject(new Error('åŠ è½½å¤±è´¥'));
                      };
                      
                      // è®¾ç½®è¶…æ—¶
                      setTimeout(() => {
                          if (!window.markdownit) {
                              console.log(`â° åŠ è½½è¶…æ—¶: ${url}`);
                              reject(new Error('åŠ è½½è¶…æ—¶'));
                          }
                      }, 5000);
                      
                      document.head.appendChild(script);
                  });
                  
                  // å¦‚æœæˆåŠŸåŠ è½½å°±é€€å‡ºå¾ªç¯
                  if (window.markdownit) {
                      break;
                  }
                  
              } catch (error) {
                  console.log(`âŒ åŠ è½½å¤±è´¥: ${url}, é”™è¯¯: ${error.message}`);
                  continue;
              }
          }
          
          if (!window.markdownit) {
              throw new Error('æ‰€æœ‰ markdown-it CDN éƒ½åŠ è½½å¤±è´¥');
          }
          
          console.log(`ç±»å‹: ${typeof window.markdownit}`);
      }
      
      // ğŸ”§ æ”¹è¿›çš„Highlight.jsåŠ è½½
      async function loadHighlightJs() {
          console.log('ğŸ”„ å°è¯•åŠ è½½ highlight.js...');
          
          if (window.hljs) {
              console.log('âœ… highlight.js å·²å­˜åœ¨');
              return;
          }
          
          const cdnUrls = [
              'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js',
              'https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
              'https://lib.baomitu.com/highlight.js/11.11.1/highlight.min.js'
          ];
          
          for (const url of cdnUrls) {
              try {
                  console.log(`ğŸ”— å°è¯•åŠ è½½: ${url}`);
                  
                  await new Promise((resolve, reject) => {
                      const script = document.createElement('script');
                      script.src = url;
                      
                      script.onload = () => {
                          if (window.hljs && typeof window.hljs.highlight === 'function') {
                              console.log(`âœ… highlight.js åŠ è½½æˆåŠŸ: ${url}`);
                              resolve();
                          } else {
                              reject(new Error('åˆå§‹åŒ–å¤±è´¥'));
                          }
                      };
                      
                      script.onerror = () => reject(new Error('åŠ è½½å¤±è´¥'));
                      setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 5000);
                      
                      document.head.appendChild(script);
                  });
                  
                  if (window.hljs) break;
                  
              } catch (error) {
                  console.log(`âŒ åŠ è½½å¤±è´¥: ${url}, é”™è¯¯: ${error.message}`);
                  continue;
              }
          }
      }
      
      // ğŸ”§ ä¿®å¤çš„åˆå§‹åŒ–å‡½æ•°
      async function init() {
          console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–ç°ä»£åŒ–Ankiå¤„ç†å™¨');
          
          try {
              // å¹¶è¡ŒåŠ è½½èµ„æºä»¥æé«˜é€Ÿåº¦
              await Promise.allSettled([
                  loadMarkdownIt(),
                  loadHighlightJs()
              ]);
              
              // éªŒè¯å…³é”®èµ„æº
              if (!window.markdownit) {
                  console.warn('âš ï¸ markdown-it æœªåŠ è½½ï¼Œå°†è·³è¿‡Markdownå¤„ç†');
              }
              
              if (!window.hljs) {
                  console.warn('âš ï¸ highlight.js æœªåŠ è½½ï¼Œå°†è·³è¿‡ä»£ç é«˜äº®');
              }
              
              setupContentProcessing();
              
              console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
              window.ankiModernInitialized = true;
              
          } catch (error) {
              console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
              // å³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿå°è¯•å¤„ç†å†…å®¹
              setupContentProcessing();
          }
      }
      
      // å¯åŠ¨
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
      } else {
          setTimeout(init, 100);
      }
      
  })(); // ç«‹å³æ‰§è¡Œå‡½æ•°ç»“æŸ
  </script>