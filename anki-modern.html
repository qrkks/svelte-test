<style>
  /* ==============================================
     现代化 Anki 代码高亮样式
     ============================================== */
  
  /* CSS 变量定义 */
  :root {
      --font-family-text: "Microsoft YaHei", "微软雅黑", "Helvetica Neue", Arial, sans-serif;
      --font-family-code: "JetBrains Mono", "Fira Code", "Consolas", "Monaco", "Courier New", monospace;
      
      /* 亮色主题 */
      --color-bg: #ffffff;
      --color-text: #1a1a1a;
      --color-code-bg: #f8f9fa;
      --color-code-border: #e9ecef;
      --color-code-text: #333333;
      --color-accent: #0066cc;
      --color-success: #10b981;
  }
  
  /* 暗色主题 */
  .nightMode {
      --color-bg: #1e1e1e;
      --color-text: #e0e0e0;
      --color-code-bg: #2d2d2d;
      --color-code-border: #404040;
      --color-code-text: #e8e8e8;
      --color-accent: #4ade80;
      --color-success: #34d399;
  }
  
  /* 全局字体 */
  #front, #back {
      font-family: var(--font-family-text);
      font-size: 20px;
      color: var(--color-text);
      background-color: var(--color-bg);
      line-height: 1.6;
  }
  
  /* 代码块容器 */
  .code-wrapper {
      position: relative;
      margin: 16px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: var(--color-code-bg);
      border: 1px solid var(--color-code-border);
  }
  
  /* 预格式化文本 */
  .code-wrapper pre {
      margin: 0;
      padding: 16px;
      background: transparent;
      border: none;
      overflow-x: auto;
      font-family: var(--font-family-code);
      font-size: 16px;
      line-height: 1.5;
  }
  
  /* 代码内容 */
  .code-wrapper code {
      font-family: inherit;
      background: transparent;
      padding: 0;
      border: none;
      color: var(--color-code-text);
      white-space: pre;
      word-wrap: normal;
  }
  
  /* 语言标签 */
  .code-lang-label {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--color-success);
      color: white;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      text-transform: uppercase;
      font-family: var(--font-family-code);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      z-index: 10;
  }
  
  .code-lang-label:hover {
      background: var(--color-accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
  }
  
  .code-lang-label:active {
      transform: translateY(0);
  }
  
  .code-lang-label.copied {
      background: var(--color-success);
      animation: pulse 0.3s ease;
  }
  
  @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
  }
  
  /* 行内代码 */
  :not(pre) > code {
      background: var(--color-code-bg);
      color: var(--color-code-text);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      font-family: var(--font-family-code);
      border: 1px solid var(--color-code-border);
  }
  
  /* 图片样式 */
  img {
      max-width: 100%;
      max-height: 80vh;
      height: auto;
      width: auto;
      display: block;
      margin: 16px auto;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      object-fit: contain;
  }
  
  /* 错误提示 */
  .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      color: #dc2626;
      font-size: 14px;
  }
  
  .nightMode .error-message {
      background: #3d1a1a;
      border: 1px solid #8b2635;
      color: #ff6b6b;
  }
  
  /* 暗色模式适配 */
  .nightMode img {
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
  }
  </style>
  
  
  <script>
  /* ==============================================
     现代化 Anki Markdown 处理器 - 防重复版本
     ============================================== */
  
  // 🔧 防止重复执行的安全机制
  (function() {
      'use strict';
      
      // 如果已经初始化过，直接退出
      if (window.ankiModernLoaded) {
          console.log('[Anki Modern] 已加载，跳过重复执行');
          return;
      }
      
      window.ankiModernLoaded = true;
      console.log('[Anki Modern] 开始加载...');
      
      // 创建调试面板
      function createDebugPanel() {
          if (document.getElementById('debug-panel')) return;
          
          const debugPanel = document.createElement('div');
          debugPanel.id = 'debug-panel';
          debugPanel.style.cssText = `
              position: fixed;
              top: 10px;
              right: 10px;
              background: #000;
              color: #0f0;
              padding: 10px;
              border-radius: 5px;
              font-family: monospace;
              font-size: 12px;
              max-width: 300px;
              max-height: 200px;
              overflow-y: auto;
              z-index: 9999;
              border: 2px solid #0f0;
          `;
          debugPanel.innerHTML = '<div><strong>🔧 Anki Modern Debug</strong></div><div id="debug-log"></div>';
          document.body.appendChild(debugPanel);
      }
      
      // 调试日志函数
      function debugLog(message, type = 'info') {
          const colors = { info: '#0f0', error: '#f00', warning: '#ff0', success: '#0f0' };
          console.log(`[Anki Modern] ${message}`);
          
          const debugLogElement = document.getElementById('debug-log');
          if (debugLogElement) {
              const logEntry = document.createElement('div');
              logEntry.style.color = colors[type] || '#0f0';
              logEntry.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
              debugLogElement.appendChild(logEntry);
              debugLogElement.scrollTop = debugLogElement.scrollHeight;
          }
      }
      
      // 创建测试按钮
      function createTestButton() {
          if (document.querySelector('.anki-test-btn')) return;
          
          const testBtn = document.createElement('button');
          testBtn.className = 'anki-test-btn';
          testBtn.innerHTML = '🧪 测试';
          testBtn.style.cssText = `
              position: fixed;
              bottom: 10px;
              right: 10px;
              background: #007acc;
              color: white;
              border: none;
              padding: 10px;
              border-radius: 5px;
              cursor: pointer;
              z-index: 9999;
          `;
          
          testBtn.onclick = runTest;
          document.body.appendChild(testBtn);
      }
      
      // 简单的测试函数
      function runTest() {
          debugLog('🧪 开始测试...', 'info');
          
          // 基础检查
          debugLog(`Highlight.js: ${window.hljs ? '✅' : '❌'}`, window.hljs ? 'success' : 'error');
          debugLog(`Markdown-it: ${window.markdownit ? '✅' : '❌'}`, window.markdownit ? 'success' : 'error');
          debugLog(`KaTeX: ${window.katex ? '✅' : '❌'}`, window.katex ? 'success' : 'error');
          
          // 如果 markdown-it 不存在，立即尝试加载
          if (!window.markdownit) {
              debugLog('🔄 尝试加载 markdown-it...', 'warning');
              loadMarkdownIt();
          }
          
          // 测试内容
          const frontEl = document.getElementById('front');
          if (frontEl) {
              frontEl.innerHTML = `
# 测试标题

这是**粗体**和*斜体*文本。

\`\`\`javascript
function hello() {
    console.log("Hello World!");
}
\`\`\`

行内代码：\`console.log("test")\`
              `;
              debugLog('✅ 测试内容已插入', 'success');
              
              // 如果 markdown-it 可用，立即处理
              if (window.markdownit) {
                  processContent(frontEl);
              }
          }
      }
      
      // 🔧 修复的资源加载 - 多个CDN备选方案
      async function loadMarkdownIt() {
          console.log('🔄 尝试加载 markdown-it...');
          
          // 检查是否已经加载
          if (window.markdownit) {
              console.log('✅ markdown-it 已存在');
              return;
          }
          
          console.log('📦 开始加载 markdown-it...');
          
          // 多个备用CDN链接
          const cdnUrls = [
              'https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js',
              'https://unpkg.com/markdown-it@14.1.0/dist/markdown-it.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/markdown-it/14.1.0/markdown-it.min.js',
              'https://lib.baomitu.com/markdown-it/14.1.0/markdown-it.min.js'
          ];
          
          for (const url of cdnUrls) {
              try {
                  console.log(`🔗 尝试加载: ${url}`);
                  
                  // 先检查链接是否可访问
                  const testResponse = await fetch(url, { method: 'HEAD' }).catch(() => null);
                  if (!testResponse || !testResponse.ok) {
                      console.log(`❌ 链接不可访问: ${url}`);
                      continue;
                  }
                  
                  await new Promise((resolve, reject) => {
                      const script = document.createElement('script');
                      script.src = url;
                      
                      script.onload = () => {
                          // 验证是否正确加载
                          if (window.markdownit && typeof window.markdownit === 'function') {
                              console.log(`✅ markdown-it 加载成功: ${url}`);
                              resolve();
                          } else {
                              console.log(`❌ 文件加载但初始化失败: ${url}`);
                              reject(new Error('初始化失败'));
                          }
                      };
                      
                      script.onerror = () => {
                          console.log(`❌ 脚本加载失败: ${url}`);
                          reject(new Error('加载失败'));
                      };
                      
                      // 设置超时
                      setTimeout(() => {
                          if (!window.markdownit) {
                              console.log(`⏰ 加载超时: ${url}`);
                              reject(new Error('加载超时'));
                          }
                      }, 5000);
                      
                      document.head.appendChild(script);
                  });
                  
                  // 如果成功加载就退出循环
                  if (window.markdownit) {
                      break;
                  }
                  
              } catch (error) {
                  console.log(`❌ 加载失败: ${url}, 错误: ${error.message}`);
                  continue;
              }
          }
          
          if (!window.markdownit) {
              throw new Error('所有 markdown-it CDN 都加载失败');
          }
          
          console.log(`类型: ${typeof window.markdownit}`);
      }
      
      // 🔧 改进的Highlight.js加载
      async function loadHighlightJs() {
          console.log('🔄 尝试加载 highlight.js...');
          
          if (window.hljs) {
              console.log('✅ highlight.js 已存在');
              return;
          }
          
          const cdnUrls = [
              'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js',
              'https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
              'https://lib.baomitu.com/highlight.js/11.11.1/highlight.min.js'
          ];
          
          for (const url of cdnUrls) {
              try {
                  console.log(`🔗 尝试加载: ${url}`);
                  
                  await new Promise((resolve, reject) => {
                      const script = document.createElement('script');
                      script.src = url;
                      
                      script.onload = () => {
                          if (window.hljs && typeof window.hljs.highlight === 'function') {
                              console.log(`✅ highlight.js 加载成功: ${url}`);
                              resolve();
                          } else {
                              reject(new Error('初始化失败'));
                          }
                      };
                      
                      script.onerror = () => reject(new Error('加载失败'));
                      setTimeout(() => reject(new Error('加载超时')), 5000);
                      
                      document.head.appendChild(script);
                  });
                  
                  if (window.hljs) break;
                  
              } catch (error) {
                  console.log(`❌ 加载失败: ${url}, 错误: ${error.message}`);
                  continue;
              }
          }
      }
      
      // 🔧 修复的初始化函数
      async function init() {
          console.log('🚀 开始初始化现代化Anki处理器');
          
          try {
              // 并行加载资源以提高速度
              await Promise.allSettled([
                  loadMarkdownIt(),
                  loadHighlightJs()
              ]);
              
              // 验证关键资源
              if (!window.markdownit) {
                  console.warn('⚠️ markdown-it 未加载，将跳过Markdown处理');
              }
              
              if (!window.hljs) {
                  console.warn('⚠️ highlight.js 未加载，将跳过代码高亮');
              }
              
              setupContentProcessing();
              
              console.log('✅ 初始化完成');
              window.ankiModernInitialized = true;
              
          } catch (error) {
              console.error('❌ 初始化失败:', error);
              // 即使部分失败也尝试处理内容
              setupContentProcessing();
          }
      }
      
      // 启动
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
      } else {
          setTimeout(init, 100);
      }
      
  })(); // 立即执行函数结束
  </script>