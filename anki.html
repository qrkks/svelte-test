<style>
  /* å…¨å±€å­—ä½“è®¾ç½® */
  #front,
  #back,
  #front *,
  #back * {
    font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", "Helvetica Neue", Arial,
      sans-serif;
  }

  /* ä¿æŒä»£ç ç­‰å®½å­—ä½“ */
  #front pre,
  #back pre,
  #front code,
  #back code,
  #front pre *,
  #back pre *,
  #front code *,
  #back code * {
    font-family: "Consolas", "Monaco", "Courier New", monospace;
  }

  /* æ­£å¸¸æ ·å¼ */
  #front,
  #back {
    font-size: 20px;
    color: black;
    background-color: white;
    line-height: 1.6;
  }
  .card {
    color: black;
    background-color: white;
  }

  /* ä»£ç å—æ ·å¼ */
  pre {
    position: relative;
    background: #f8f8f8;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin: 10px 0;
    overflow: auto;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap !important;  /* å¼ºåˆ¶ä¿æŒæ¢è¡Œå¹¶å…è®¸è‡ªåŠ¨æŠ˜è¡Œ */
    word-wrap: break-word;              /* é•¿è¡Œè‡ªåŠ¨æŠ˜è¡Œ */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  pre code {
    background: transparent;
    padding: 0;
    border: none;
    font-size: 18px;
    line-height: 1.5;
    white-space: pre-wrap !important;  /* ç¡®ä¿ä»£ç å†…å®¹ä¿æŒæ¢è¡Œ */
    word-wrap: break-word;              /* ç¡®ä¿é•¿è¡Œèƒ½æ­£ç¡®æŠ˜è¡Œ */
    display: block;                     /* ç¡®ä¿æ˜¯å—çº§å…ƒç´  */
  }

  /* è¯­è¨€æ ‡è¯†ç¬¦æ ·å¼ */
  .code-lang-label {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #5f8f55;
    color: white;
    padding: 2px 8px;
    font-size: 12px;
    font-weight: bold;
    border-radius: 0 4px 0 4px;
    text-transform: uppercase;
    font-family: "Consolas", "Monaco", "Courier New", monospace;
    z-index: 100;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }

  .code-lang-label:hover {
    background: #10b981;
    box-shadow: 0 2px 8px rgba(52, 211, 153, 0.3);
  }

  .code-lang-label:active {
    background: #059669;
    box-shadow: 0 1px 4px rgba(52, 211, 153, 0.5);
  }

  .code-lang-label.copied {
    background: #10b981;
    animation: pulse 0.3s ease;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 rgba(52, 211, 153, 0.7); }
    50% { box-shadow: 0 0 20px rgba(52, 211, 153, 0.7); }
    100% { box-shadow: 0 0 0 rgba(52, 211, 153, 0.7); }
  }

  /* è¡Œå†…ä»£ç  */
  code {
    background: #f1f1f1;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
    color: #333; /* æ”¹ä¸ºæ·±ç°è‰²ï¼Œä¸è¦çº¢è‰² */
  }

  /* æ ‡ç­¾æ ·å¼ */
  .tags {
    text-align: center;
    margin-top: 10px;
  }
  .tag::before {
    content: "#";
  }
  .tag:empty {
    display: none;
  }
  .tag {
    color: white;
    background-color: #9f2bff;
    border: none;
    font-size: 11px;
    font-weight: bold;
    padding: 3px 8px;
    margin: 0px 3px;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    border-radius: 14px;
    display: inline-block;
    vertical-align: middle;
  }

  /* cloze é«˜äº® */
  .cloze {
    font-weight: bold;
    color: blue;
  }
  .nightMode .cloze {
    color: lightblue;
  }

  /* å›¾ç‰‡æ ·å¼ */
  img {
    max-width: 100%;
    max-height: 80vh;  /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†çª—é«˜åº¦çš„80% */
    height: auto;
    width: auto;       /* ç¡®ä¿å®½åº¦ä¹Ÿèƒ½è‡ªåŠ¨è°ƒæ•´ */
    display: block;
    margin: 10px auto;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    object-fit: contain; /* ç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¿æŒæ¯”ä¾‹ */
  }

  /* æš—é»‘æ¨¡å¼ */
  .nightMode #front,
  .nightMode #back,
  .nightMode .card {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }
  .nightMode img {
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
  }
  .nightMode pre {
    background: #2d2d2d !important;
    border: 1px solid #444;
    box-shadow: none;
    white-space: pre-wrap !important;  /* ç¡®ä¿æš—é»‘æ¨¡å¼ä¸‹ä¹Ÿä¿æŒæ¢è¡Œ */
    word-wrap: break-word;
  }
  .nightMode code {
    background: #3a3a3a;
    color: #ffb86c;
  }
  .nightMode pre code {
    color: #e8e8e8;
    white-space: pre-wrap !important;  /* ç¡®ä¿æš—é»‘æ¨¡å¼ä¸‹ä»£ç å†…å®¹ä¿æŒæ¢è¡Œ */
    word-wrap: break-word;
  }
  .nightMode .tag {
    background-color: #ffffff33;
    color: #ffffff;
  }
  .nightMode .code-lang-label {
    background: #4ade80;
    color: #ffffff;
  }

  /* ä¸‰çº¿è¡¨æ ·å¼ */
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 12px 0;
    font-size: 18px;
  }
  table thead tr {
    border-bottom: 2px solid #000;
  }
  table tbody tr:last-child {
    border-bottom: 2px solid #000;
  }
  table th {
    border-top: 2px solid #000;
    padding: 8px 12px;
    text-align: left;
  }
  table td {
    border: none;
    padding: 8px 12px;
  }
  .nightMode table thead tr {
    border-bottom: 2px solid #aaa;
  }
  .nightMode table tbody tr:last-child {
    border-bottom: 2px solid #aaa;
  }
  .nightMode table th {
    border-top: 2px solid #aaa;
  }

  /* é”™è¯¯æç¤ºæ ·å¼ */
  .error-message {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 4px;
    padding: 12px;
    margin: 8px 0;
    color: #c62828;
    font-size: 14px;
  }
  .nightMode .error-message {
    background: #3d1a1a;
    border: 1px solid #8b2635;
    color: #ff6b6b;
  }
</style>

  <script>
    // ğŸ›¡ï¸ å®‰å…¨çš„ç¼–è¾‘æ¨¡å¼æ£€æµ‹å‡½æ•°
    function isEditModeSafe() {
      try {
        return !!(
          window.location.href.includes("editor") ||
          window.location.href.includes("browse") ||
          document.querySelector('[contenteditable="true"]') || 
          document.activeElement?.tagName === 'TEXTAREA' ||
          document.activeElement?.tagName === 'INPUT' ||
          document.querySelector('.note-editing-area') || 
          document.querySelector('.card-fields') ||
          document.querySelector('.editor-field') ||
          document.querySelector('#fields') ||
          document.body?.classList?.contains('editor') ||
          document.title.includes('ç¼–è¾‘') ||
          document.title.includes('Edit') ||
          document.title.includes('Browser') ||
          document.title.includes('æµè§ˆ')
        );
      } catch (e) {
        console.warn('ğŸš¨ ç¼–è¾‘æ¨¡å¼æ£€æµ‹å‡ºé”™ï¼Œä¸ºå®‰å…¨èµ·è§å‡è®¾ä¸ºç¼–è¾‘æ¨¡å¼:', e);
        return true; // å‡ºé”™æ—¶ä¸ºå®‰å…¨èµ·è§ï¼Œå‡è®¾æ˜¯ç¼–è¾‘æ¨¡å¼
      }
    }
    
         // âš¡ å¿«é€Ÿæ™ºèƒ½æ£€æµ‹å‡½æ•°
     function smartEditModeCheck(callback) {
       // ç¬¬ä¸€æ¬¡ç«‹å³æ£€æµ‹
       if (isEditModeSafe()) {
         console.log('ğŸ›‘ ç«‹å³æ£€æµ‹ï¼šå‘ç°ç¼–è¾‘æ¨¡å¼ï¼Œåœæ­¢åˆå§‹åŒ–');
         return;
       }
       
       // å¦‚æœURLæ˜ç¡®ä¸æ˜¯ç¼–è¾‘å™¨ï¼Œç›´æ¥å¯åŠ¨
       if (!window.location.href.includes("editor") && 
           !window.location.href.includes("browse")) {
         console.log('âœ… URLæ£€æµ‹ï¼šæ˜ç¡®éç¼–è¾‘æ¨¡å¼ï¼Œç«‹å³å¯åŠ¨');
         callback();
         return;
       }
       
       // å¯¹äºå¯èƒ½çš„ç¼–è¾‘æ¨¡å¼ï¼Œå¿«é€Ÿæ£€æµ‹å‡ æ¬¡
       let checkCount = 0;
       const maxChecks = 3;        // å‡å°‘åˆ°3æ¬¡
       const checkInterval = 20;   // å‡å°‘åˆ°20ms
       
       function quickCheck() {
         checkCount++;
         
         if (isEditModeSafe()) {
           console.log(`ğŸ›‘ ç¬¬${checkCount}æ¬¡å¿«é€Ÿæ£€æµ‹ï¼šå‘ç°ç¼–è¾‘æ¨¡å¼ï¼Œåœæ­¢åˆå§‹åŒ–`);
           return;
         }
         
         if (checkCount >= maxChecks) {
           console.log('âœ… å¿«é€Ÿæ£€æµ‹ç¡®è®¤ï¼šéç¼–è¾‘æ¨¡å¼ï¼Œå¼€å§‹åˆå§‹åŒ–');
           callback();
           return;
         }
         
         setTimeout(quickCheck, checkInterval);
       }
       
       quickCheck();
     }
    
         // ğŸš€ ä½¿ç”¨æ™ºèƒ½å¿«é€Ÿæ£€æµ‹å¯åŠ¨
     console.log("âš¡ å¼€å§‹å¿«é€Ÿç¼–è¾‘æ¨¡å¼æ£€æµ‹");
     
     smartEditModeCheck(() => {
    (function () {
      // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ï¼Œå¿½ç•¥ç¼“å­˜
      window.ankiMarkdownInitialized = false;

    if (window.ankiMarkdownInitialized) return;
    window.ankiMarkdownInitialized = true;

    // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æ–°ä»£ç 
    console.log("ğŸ”„ Anki Markdown é‡æ–°åˆå§‹åŒ– - Version 2.0");

    const RESOURCES = {
      css: [
        [
          "_katex-0.16.22.css",
          "https://npm.elemecdn.com/katex@0.16.22/dist/katex.min.css",
        ],
        [
          "_highlight-11.11.1.css",
          "https://lib.baomitu.com/highlight.js/11.11.1/styles/default.min.css",
        ],
      ],
      scripts: [
        [
          "_highlight-11.11.1.js",
          "https://lib.baomitu.com/highlight.js/11.11.1/highlight.min.js",
        ],
        [
          "_katex-0.16.22.min.js",
          "https://npm.elemecdn.com/katex@0.16.22/dist/katex.min.js",
        ],
        [
          "_auto-render-0.16.22.js",
          "https://npm.elemecdn.com/katex@0.16.22/dist/contrib/auto-render.min.js",
        ],
        [
          "_markdown-it-14.1.0.min.js",
          "https://lib.baomitu.com/markdown-it/14.1.0/markdown-it.min.js",
        ],
        [
          "_markdown-it-mark.js",
          "https://jsd.ink/gh/Jwrede/Anki-KaTeX-Markdown/_markdown-it-mark.js",
        ],
        [
          "_mhchem-0.16.22.js",
          "https://npm.elemecdn.com/katex@0.16.22/dist/contrib/mhchem.min.js",
        ],
      ],
    };


    function loadCSS([path, cdn]) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`link[href="${path}"], link[href="${cdn}"]`))
          return resolve();
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = path;
        link.onload = () => {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ“ æœ¬åœ°';
          resolve();
        };
        link.onerror = () => {
          const fallback = document.createElement("link");
          fallback.rel = "stylesheet";
          fallback.href = cdn;
          fallback.onload = () => {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = 'ğŸŒ CDN';
            resolve();
          };
          fallback.onerror = reject;
          document.head.appendChild(fallback);
        };
        document.head.appendChild(link);
      });
    }

    function loadScript([path, cdn]) {
      return new Promise((resolve, reject) => {
        if (cdn.includes("highlight") && window.hljs) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ’¾ ç¼“å­˜';
          return resolve();
        }
        if (cdn.includes("katex") && window.katex) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ’¾ ç¼“å­˜';
          return resolve();
        }
        if (cdn.includes("auto-render") && window.renderMathInElement) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ’¾ ç¼“å­˜';
          return resolve();
        }
        if (cdn.includes("mhchem") && window.katex?.__chemParse) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ’¾ ç¼“å­˜';
          return resolve();
        }
        if (cdn.includes("markdown-it") && window.markdownit) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ’¾ ç¼“å­˜';
          return resolve();
        }
        if (cdn.includes("markdown-it-mark") && window.markdownItMark) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ’¾ ç¼“å­˜';
          return resolve();
        }
        const script = document.createElement("script");
        script.src = path;
        script.onload = () => {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus[path] = 'ğŸ“ æœ¬åœ°';
          resolve();
        };
        script.onerror = () => {
          const fallback = document.createElement("script");
          fallback.src = cdn;
          fallback.onload = () => {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus[path] = 'ğŸŒ CDN';
            resolve();
          };
          fallback.onerror = reject;
          document.head.appendChild(fallback);
        };
        document.head.appendChild(script);
      });
    }

    function cleanHTML(html) {
      // ğŸ–¼ï¸ åˆ†åˆ«ä¿æŠ¤å›¾ç‰‡å’ŒéŸ³é¢‘ç­‰åª’ä½“å†…å®¹
      const imgPlaceholders = [];
      const soundPlaceholders = [];
      let tempHtml = html;
      
      // ä¿æŠ¤ <img> æ ‡ç­¾
      tempHtml = tempHtml.replace(/<img[^>]*>/gi, function(match) {
        const placeholder = `__IMG_PLACEHOLDER_${imgPlaceholders.length}__`;
        imgPlaceholders.push(match);
        return placeholder;
      });
      
      // ä¿æŠ¤éŸ³é¢‘æ–‡ä»¶å¼•ç”¨
      tempHtml = tempHtml.replace(/\[sound:[^\]]+\]/gi, function(match) {
        const placeholder = `__SOUND_PLACEHOLDER_${soundPlaceholders.length}__`;
        soundPlaceholders.push(match);
        return placeholder;
      });
      
      // ğŸ’» åªä¿æŠ¤Markdownæ ¼å¼çš„ä»£ç å—ï¼ˆä¸ä¿æŠ¤HTMLæ ¼å¼ï¼‰
      const codeBlockPlaceholders = [];
      
      // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨ä¿®å¤å¯Œæ–‡æœ¬ä»£ç å—ï¼ˆ```åŒ…å›´çš„å†…å®¹ï¼‰
      tempHtml = tempHtml.replace(/```(\w+)?(<br>|<br\s*\/?>|&nbsp;|\s)*([^`]*?)```/gi, 
        function(match, lang, whitespace, content) {
          console.log('ğŸ”§ å‘ç°å¯Œæ–‡æœ¬ä»£ç å—ï¼Œæ­£åœ¨æ¸…ç†:', lang || 'æœªæŒ‡å®šè¯­è¨€');
          
          // æ¸…ç†ä»£ç å—å†…çš„HTMLæ ‡ç­¾å’Œå®ä½“ï¼Œç‰¹åˆ«æ³¨æ„ä¿ç•™æ¢è¡Œç¬¦
          const cleanContent = content
            .replace(/<br\s*\/?>/gi, "\n")      // <br> â†’ æ¢è¡Œ
            .replace(/<\/div>\s*<div[^>]*>/gi, "\n")  // divæ¢è¡Œ â†’ æ¢è¡Œç¬¦
            .replace(/<div[^>]*>/gi, "\n")      // divå¼€å§‹ â†’ æ¢è¡Œç¬¦  
            .replace(/<\/div>/gi, "")           // divç»“æŸ â†’ æ¸…é™¤
            .replace(/&nbsp;/gi, " ")           // &nbsp; â†’ ç©ºæ ¼
            .replace(/&lt;/gi, "<")             // &lt; â†’ <
            .replace(/&gt;/gi, ">")             // &gt; â†’ >
            .replace(/&amp;/gi, "&")            // &amp; â†’ &
            .replace(/&quot;/gi, '"')           // &quot; â†’ "
            .replace(/&#39;/gi, "'")            // &#39; â†’ '
            .replace(/<\/?[^>]+(>|$)/gi, "")    // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾
            .replace(/\n{3,}/g, "\n\n")         // è¿ç»­3ä¸ªä»¥ä¸Šæ¢è¡Œ â†’ 2ä¸ªæ¢è¡Œ
            .replace(/^\s+|\s+$/g, "");         // å»é™¤é¦–å°¾ç©ºç™½ï¼Œä½†ä¿ç•™å†…éƒ¨æ¢è¡Œ
          
          const placeholder = `__FIXED_CODE_BLOCK_${codeBlockPlaceholders.length}__`;
          codeBlockPlaceholders.push("```" + (lang || "") + "\n" + cleanContent + "\n```");
          console.log('âœ… ä»£ç å—æ¸…ç†å®Œæˆï¼Œä¿ç•™äº†æ¢è¡Œç¬¦');
          return placeholder;
        }
      );
      
      // ğŸ”§ ç‰¹æ®Šå¤„ç†ï¼šä¸å®Œæ•´çš„ä»£ç å—ï¼ˆ```å¼€å§‹ä½†è¢«divåˆ†å‰²ï¼‰
      tempHtml = tempHtml.replace(/```(\w+)?\s*(<\/div>\s*<div[^>]*>[\s\S]*?)```/gi, function(match, lang, content) {
        console.log('ğŸ”§ å‘ç°è¢«divåˆ†å‰²çš„ä»£ç å—ï¼Œæ­£åœ¨æ¸…ç†:', lang || 'æœªæŒ‡å®šè¯­è¨€');
        
        // æ¸…ç†ä»£ç å—å†…çš„divæ ‡ç­¾
        const cleanContent = content
          .replace(/<\/div>\s*<div[^>]*>/gi, "\n")
          .replace(/<\/div>/gi, "\n")
          .replace(/<div[^>]*>/gi, "\n")
          .replace(/&gt;/gi, ">")
          .replace(/&lt;/gi, "<")
          .replace(/&amp;/gi, "&")
          .replace(/<[^>]*>/gi, "")
          .trim();
        
        const placeholder = `__DIV_CODE_BLOCK_${codeBlockPlaceholders.length}__`;
        codeBlockPlaceholders.push("```" + (lang || "") + "\n" + cleanContent + "\n```");
        console.log('âœ… divåˆ†å‰²ä»£ç å—æ¸…ç†å®Œæˆ');
        return placeholder;
      });
      
      // ä¿æŠ¤å®Œæ•´çš„Markdownä»£ç å—
      tempHtml = tempHtml.replace(/```[\s\S]*?```/gi, function(match) {
        const placeholder = `__COMPLETE_CODE_BLOCK_${codeBlockPlaceholders.length}__`;
        codeBlockPlaceholders.push(match);
        return placeholder;
      });
      
      // ğŸ”§ ä¿æŠ¤è¡Œå†…ä»£ç ï¼Œé¿å…HTMLæ¸…ç†è¿‡ç¨‹å½±å“å…¶å†…å®¹
      tempHtml = tempHtml.replace(/`([^`\n]*)`/gi, function(match, content) {
        // ä¿æŠ¤è¡Œå†…ä»£ç å†…å®¹ï¼Œä½¿ç”¨ç‰¹æ®Šç¼–ç é¿å…è¢«HTMLæ¸…ç†å½±å“
        const protectedContent = content
          .replace(/&lt;/gi, '____LT____')    // ä¸´æ—¶ä¿æŠ¤&lt;
          .replace(/&gt;/gi, '____GT____')    // ä¸´æ—¶ä¿æŠ¤&gt;
          .replace(/&amp;/gi, '____AMP____'); // ä¸´æ—¶ä¿æŠ¤&amp;
        
        const protectedMatch = '`' + protectedContent + '`';
        const placeholder = `__MD_INLINE_CODE_${codeBlockPlaceholders.length}__`;
        codeBlockPlaceholders.push(protectedMatch);
        return placeholder;
      });
      
      // ğŸ§¹ æ™ºèƒ½HTMLæ¸…ç†å’ŒMarkdownè½¬æ¢
      let cleaned = tempHtml
        // å…ˆæ¸…ç†HTMLå®ä½“ï¼Œé˜²æ­¢HTMLæ ‡ç­¾è¢«ç¼–ç 
        .replace(/&lt;/gi, "<")
        .replace(/&gt;/gi, ">")
        .replace(/&amp;/gi, "&")
        .replace(/&nbsp;/gi, " ")
        .replace(/&tab;/gi, "\t")
        .replace(/&mdash;/gi, "â€”")
        .replace(/&ndash;/gi, "â€“")
        .replace(/&quot;/gi, '"')
        .replace(/&#39;/gi, "'")
        .replace(/&hellip;/gi, "...")
        // ç‰¹æ®Šå¤„ç†ï¼šæ¸…ç†è¿ç»­çš„divæ ‡ç­¾ï¼ˆAnkiå¸¸è§æ ¼å¼ï¼‰
        .replace(/<\/div>\s*<div[^>]*>/gi, "\n")
        .replace(/<\/div>/gi, "\n")
        .replace(/<div[^>]*>/gi, "\n")
        // ğŸ”§ æ­£ç¡®å¤„ç†å¯Œæ–‡æœ¬æ ‡ç­¾è½¬æ¢ä¸ºMarkdown
        .replace(/<strong[^>]*>(.*?)<\/strong>/gi, "**$1**")  // <strong>text</strong> â†’ **text**
        .replace(/<b[^>]*>(.*?)<\/b>/gi, "**$1**")           // <b>text</b> â†’ **text**
        .replace(/<em[^>]*>(.*?)<\/em>/gi, "*$1*")           // <em>text</em> â†’ *text*
        .replace(/<i[^>]*>(.*?)<\/i>/gi, "*$1*")             // <i>text</i> â†’ *text*
        .replace(/<u[^>]*>(.*?)<\/u>/gi, "$1")               // ç§»é™¤ä¸‹åˆ’çº¿æ ‡ç­¾ä½†ä¿ç•™å†…å®¹
        // ğŸ”§ å¤„ç†æ ‡é¢˜æ ‡ç­¾
        .replace(/<h([1-6])[^>]*>(.*?)<\/h\1>/gi, function(match, level, text) {
          return "#".repeat(parseInt(level)) + " " + text + "\n";
        })
        // ğŸ”§ å¤„ç†é“¾æ¥æ ‡ç­¾
        .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, "[$2]($1)")
        // ğŸ”§ å¤„ç†åˆ—è¡¨æ ‡ç­¾
        .replace(/<ul[^>]*>/gi, "").replace(/<\/ul>/gi, "")
        .replace(/<ol[^>]*>/gi, "").replace(/<\/ol>/gi, "")
        .replace(/<li[^>]*>(.*?)<\/li>/gi, "- $1\n")
        // æ¸…ç†å…¶ä»–HTMLæ ‡ç­¾
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/<p[^>]*>/gi, "\n")
        .replace(/<\/p>/gi, "\n")
        .replace(/<span[^>]*>/gi, "")
        .replace(/<\/span>/gi, "")
        .replace(/<code[^>]*>/gi, "`")
        .replace(/<\/code>/gi, "`")
        .replace(/<pre[^>]*>/gi, "")
        .replace(/<\/pre>/gi, "")
        // æ¸…ç†ä»»ä½•å‰©ä½™çš„HTMLæ ‡ç­¾
        .replace(/<[^>]*>/gi, "")
        // æ¸…ç†å¤šä½™çš„Markdownæ ¼å¼é‡å¤
        .replace(/\*{3,}/g, "**")  // ***+ â†’ **
        .replace(/\*\*\s*\*\*/g, "")  // ** ** â†’ ç©º
        // æ¸…ç†å¤šä½™ç©ºè¡Œå’Œç©ºç™½
        .replace(/\n\s*\n\s*\n/g, "\n\n")
        .replace(/^\s+|\s+$/g, ""); // trim
      
      // ğŸ”§ ç‰¹æ®Šå¤„ç†è¡¨æ ¼ï¼šç§»é™¤è¡¨æ ¼è¡Œä¹‹é—´çš„ç©ºè¡Œ
      const lines = cleaned.split(/\r?\n/);
      const tableRowPattern = /^\s*\|.*\|\s*$/;
      let processedLines = [];
      
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        if (line) {
          processedLines.push(line);
        } else {
          // ç©ºè¡Œå¤„ç†ï¼šå¦‚æœå‰åéƒ½æ˜¯è¡¨æ ¼è¡Œï¼Œè·³è¿‡ç©ºè¡Œ
          const prevLine = processedLines[processedLines.length - 1];
          const nextLine = lines[i + 1]?.trim();
          
          if (!(tableRowPattern.test(prevLine) && tableRowPattern.test(nextLine))) {
            processedLines.push("");
          }
        }
      }
      
      let result = processedLines.join('\n');
      
      // ğŸ–¼ï¸ æ¢å¤ä¿æŠ¤çš„åª’ä½“å†…å®¹
      imgPlaceholders.forEach((original, index) => {
        const placeholder = `__IMG_PLACEHOLDER_${index}__`;
        result = result.replace(placeholder, original);
      });
      
      soundPlaceholders.forEach((original, index) => {
        const placeholder = `__SOUND_PLACEHOLDER_${index}__`;
        result = result.replace(placeholder, original);
      });
      
      // ğŸ’» æ¢å¤Markdownä»£ç å—
      codeBlockPlaceholders.forEach((original, index) => {
        const placeholder = `__FIXED_CODE_BLOCK_${index}__`;
        result = result.replace(placeholder, original);
      });
      
      codeBlockPlaceholders.forEach((original, index) => {
        const placeholder = `__DIV_CODE_BLOCK_${index}__`;
        result = result.replace(placeholder, original);
      });
      
      codeBlockPlaceholders.forEach((original, index) => {
        const placeholder = `__COMPLETE_CODE_BLOCK_${index}__`;
        result = result.replace(placeholder, original);
      });
      
      codeBlockPlaceholders.forEach((original, index) => {
        const placeholder = `__MD_INLINE_CODE_${index}__`;
        // ğŸ”§ æ¢å¤ç‰¹æ®Šç¼–ç ä¸ºåŸå§‹å­—ç¬¦ï¼Œè®©markdown-itè‡ªå·±å¤„ç†HTMLè½¬ä¹‰
        const restoredOriginal = original
          .replace(/____LT____/gi, '<')      // æ¢å¤ä¸º<å­—ç¬¦
          .replace(/____GT____/gi, '>')      // æ¢å¤ä¸º>å­—ç¬¦  
          .replace(/____AMP____/gi, '&');    // æ¢å¤ä¸º&å­—ç¬¦
        
        result = result.replace(placeholder, restoredOriginal);
      });
      
      console.log("âœ… HTMLæ¸…ç†å®Œæˆ");
      return result;
    }

          // ğŸ”’ å®‰å…¨çš„HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ğŸ”’ å®‰å…¨åœ°è®¾ç½®HTMLå†…å®¹ï¼ˆé˜²æ­¢è„šæœ¬æ‰§è¡Œï¼‰
    function safeSetHTML(element, htmlContent) {
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨
      const temp = document.createElement('div');
      temp.innerHTML = htmlContent;
      
      // ç§»é™¤æ‰€æœ‰å¯èƒ½æ‰§è¡Œçš„è„šæœ¬æ ‡ç­¾å’Œäº‹ä»¶å¤„ç†å™¨
      const scripts = temp.querySelectorAll('script');
      scripts.forEach(script => script.remove());
      
      // ç§»é™¤æ‰€æœ‰äº‹ä»¶å±æ€§
      const allElements = temp.querySelectorAll('*');
      allElements.forEach(el => {
        // ç§»é™¤æ‰€æœ‰ä»¥ 'on' å¼€å¤´çš„å±æ€§ï¼ˆå¦‚ onclick, onload ç­‰ï¼‰
        Array.from(el.attributes).forEach(attr => {
          if (attr.name.toLowerCase().startsWith('on')) {
            el.removeAttribute(attr.name);
          }
        });
        
        // ç§»é™¤ javascript: é“¾æ¥
        if (el.href && el.href.toLowerCase().startsWith('javascript:')) {
          el.removeAttribute('href');
        }
        if (el.src && el.src.toLowerCase().startsWith('javascript:')) {
          el.removeAttribute('src');
        }
      });
      
      // å®‰å…¨åœ°è®¾ç½®å†…å®¹
      element.innerHTML = temp.innerHTML;
    }

    // ğŸ”’ å®‰å…¨çš„ä»£ç é«˜äº®å‡½æ•°ï¼ˆé˜²æ­¢ä»£ç æ‰§è¡Œï¼‰
    function addCodeHighlight(container) {
      const codeBlocks = container.querySelectorAll("pre code");
      if (codeBlocks.length === 0) return;
      
      console.log(`ğŸ¨ å®‰å…¨å¤„ç† ${codeBlocks.length} ä¸ªä»£ç å—`);

      codeBlocks.forEach((block, index) => {
        try {
          // ğŸ”’ å®‰å…¨åœ°è·å–ä»£ç å†…å®¹ï¼ˆåªè·å–æ–‡æœ¬ï¼Œä¸æ‰§è¡Œï¼‰
          let code = block.textContent || block.innerText || "";
          
          // ğŸ”§ ç¡®ä¿æ¢è¡Œç¬¦è¢«æ­£ç¡®ä¿ç•™
          if (!code.includes('\n') && block.innerHTML.includes('<br')) {
            // å¦‚æœtextContentæ²¡æœ‰æ¢è¡Œä½†HTMLä¸­æœ‰<br>ï¼Œæ‰‹åŠ¨è½¬æ¢
            code = block.innerHTML
              .replace(/<br\s*\/?>/gi, '\n')
              .replace(/<[^>]*>/g, '') // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&amp;/g, '&')
              .replace(/&quot;/g, '"')
              .replace(/&#39;/g, "'");
          }
          
          // ğŸ›¡ï¸ é¢å¤–å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœä»£ç åŒ…å«å¯ç–‘å†…å®¹ï¼Œç›´æ¥è·³è¿‡é«˜äº®
          // ä¸´æ—¶æ³¨é‡Šæ‰å®‰å…¨æ£€æŸ¥è¿›è¡Œæµ‹è¯•
          /*
          if (code.includes('<script') || code.includes('javascript:') || code.includes('eval(')) {
            console.warn(`ğŸš¨ æ£€æµ‹åˆ°å¯ç–‘ä»£ç ï¼Œè·³è¿‡é«˜äº®å¤„ç†`);
            addLanguageLabel(block.parentElement, "text");
            return;
          }
          */

                      // ğŸš€ è·å–è¯­è¨€ä¿¡æ¯çš„ä¼˜å…ˆçº§ï¼šæ³¨é‡Š > CSSç±»å
          let lang = "";
          let alreadyHighlighted = false;
          
          // ä»CSSç±»åè·å–è¯­è¨€
          if (block.className) {
            const match = block.className.match(/language-(\w+)/);
            if (match) {
              lang = match[1];
            }
          }

          // ğŸ”’ ç®€åŒ–çš„é«˜äº®å¤„ç†é€»è¾‘
          let highlightedCode;
          let finalLanguage;
          
          if (lang && window.hljs) {
            // æœ‰æŒ‡å®šè¯­è¨€ â†’ ä½¿ç”¨ highlightAuto
            try {
              const result = window.hljs.highlightAuto(code, [lang]);
              highlightedCode = result.value;
              finalLanguage = lang;
            } catch (e) {
              highlightedCode = escapeHtml(code);
              finalLanguage = lang;
            }
          } else if (window.hljs) {
            // æ²¡æœ‰æŒ‡å®šè¯­è¨€ â†’ è‡ªåŠ¨æ£€æµ‹
            try {
              const result = window.hljs.highlightAuto(code);
              highlightedCode = result.value;
              finalLanguage = result.language || "auto";
            } catch (e) {
              highlightedCode = escapeHtml(code);
              finalLanguage = "text";
            }
          } else {
            // highlight.js æœªåŠ è½½
            highlightedCode = escapeHtml(code);
            finalLanguage = lang || "text";
          }

          // ğŸ”’ å®‰å…¨åœ°åº”ç”¨é«˜äº®ç»“æœ
          safeSetHTML(block, highlightedCode);

          // æ·»åŠ è¯­è¨€æ ‡è¯†ç¬¦
          addLanguageLabel(block.parentElement, finalLanguage);
        } catch (error) {
          console.warn(`âš ï¸ ä»£ç é«˜äº®å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬:`, error.message);
          // å®‰å…¨å›é€€ï¼šä½¿ç”¨è½¬ä¹‰çš„åŸå§‹æ–‡æœ¬
          const safeCode = escapeHtml(block.textContent || block.innerText || "");
          block.innerHTML = safeCode;
          addLanguageLabel(block.parentElement, "text");
        }
      });
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
    async function copyToClipboard(text, button) {
      const originalText = button.textContent;
      
      try {
        await navigator.clipboard.writeText(text);
        
        // è§†è§‰åé¦ˆ
        button.classList.add('copied');
        button.textContent = 'å·²å¤åˆ¶';
        
        setTimeout(() => {
          button.classList.remove('copied');
          button.textContent = originalText;
        }, 1000);
        
        console.log('ğŸ“‹ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      } catch (err) {
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„ execCommand
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.opacity = '0';
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          
          // åŒæ ·çš„è§†è§‰åé¦ˆ
          button.classList.add('copied');
          button.textContent = 'å·²å¤åˆ¶';
          
          setTimeout(() => {
            button.classList.remove('copied');
            button.textContent = originalText;
          }, 1000);
          
          console.log('ğŸ“‹ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (fallback)');
        } catch (fallbackErr) {
          console.warn('âŒ å¤åˆ¶å¤±è´¥:', fallbackErr);
          button.textContent = 'å¤åˆ¶å¤±è´¥';
          setTimeout(() => {
            button.textContent = originalText;
          }, 1000);
        }
      }
    }

    // æ·»åŠ è¯­è¨€æ ‡è¯†ç¬¦å‡½æ•°
    function addLanguageLabel(preElement, language) {
      // æ£€æŸ¥preå…ƒç´ æ˜¯å¦å·²ç»è¢«åŒ…è£…
      let wrapper = preElement.parentElement;
      if (!wrapper.classList.contains('code-wrapper')) {
        // åˆ›å»ºåŒ…è£…å®¹å™¨
        wrapper = document.createElement('div');
        wrapper.className = 'code-wrapper';
        wrapper.style.position = 'relative';
        wrapper.style.display = 'block';
        
        // å°†preå…ƒç´ åŒ…è£…èµ·æ¥
        preElement.parentNode.insertBefore(wrapper, preElement);
        wrapper.appendChild(preElement);
      }

      // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ ‡ç­¾
      const existingLabel = wrapper.querySelector(".code-lang-label");
      if (existingLabel) {
        existingLabel.remove();
      }

      // åˆ›å»ºè¯­è¨€æ ‡ç­¾
      const langLabel = document.createElement("div");
      langLabel.className = "code-lang-label";
      langLabel.textContent = language;
      langLabel.title = "ç‚¹å‡»å¤åˆ¶ä»£ç ";

      // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
      langLabel.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // è·å–ä»£ç å—å†…å®¹
        const codeElement = preElement.querySelector('code');
        if (codeElement) {
          const codeText = codeElement.textContent || codeElement.innerText || '';
          await copyToClipboard(codeText, langLabel);
        }
      });

      // æ·»åŠ åˆ°åŒ…è£…å®¹å™¨è€Œä¸æ˜¯preå…ƒç´ 
      wrapper.appendChild(langLabel);
    }

          function renderMarkdown(ID) {

      const el = document.getElementById(ID);
      if (!el || el.dataset.markdownProcessed === "true") return;

      // ğŸ”’ å®‰å…¨é¢„æ£€æŸ¥
      const original = el.innerHTML;
      if (original.includes('<script') || original.includes('javascript:')) {
        console.warn(`ğŸš¨ æ£€æµ‹åˆ°å¯ç–‘å†…å®¹ï¼Œè·³è¿‡å¤„ç†: ${ID}`);
        return;
      }

      // åˆ›å»ºå®‰å…¨çš„markdown-itå®ä¾‹
      const md = window.markdownit({
        html: true,
        breaks: true,
        typographer: true,
        linkify: true,
        // ğŸ”’ å®‰å…¨çš„ä»£ç å—å¤„ç†ï¼Œç¡®ä¿HTMLè¢«æ­£ç¡®è½¬ä¹‰
        highlight: function (str, lang) {
          if (typeof str !== 'string') return str || '';
          
          const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };
          
          let highlightedCode = "";
          let actualLang = lang || "";
          
          if (lang && window.hljs) {
            try {
              const result = window.hljs.highlightAuto(str, [lang]);
              highlightedCode = result.value;
              actualLang = lang;
            } catch (e) {
              highlightedCode = escapeHtml(str);
              actualLang = lang || "text";
            }
          } else {
            highlightedCode = escapeHtml(str);
            actualLang = lang || "text";
          }
          
          return `<!-- lang:${actualLang} -->${highlightedCode}`;
        },
      });

      if (window.markdownItMark) md.use(window.markdownItMark);

      try {
        const text = cleanHTML(original);
        const rendered = md.render(text);

        // ğŸ”’ ä½¿ç”¨å®‰å…¨çš„æ–¹å¼è®¾ç½®HTMLå†…å®¹
        safeSetHTML(el, rendered);
        el.dataset.markdownProcessed = "true";

        // âœ… å®‰å…¨çš„ä»£ç é«˜äº®åŠŸèƒ½
        addCodeHighlight(el);

      } catch (error) {
        console.error(`âŒ æ¸²æŸ“å¤±è´¥ ${ID}:`, error.message);
        // å®‰å…¨å›é€€ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯è€Œä¸æ˜¯å¯èƒ½çš„æ¶æ„å†…å®¹
        el.innerHTML = `<p style="color: red;">âŒ å†…å®¹æ¸²æŸ“å¤±è´¥</p>`;
      }
    }

    function renderMath(ID) {
      const el = document.getElementById(ID);
      if (
        !el ||
        el.dataset.katexRendered === "true" ||
        !window.renderMathInElement
      )
        return;
      renderMathInElement(el, {
        delimiters: [
          {left: "$$", right: "$$", display: true},
          {left: "$", right: "$", display: false},
        ],
        throwOnError: false,
        macros: {
          "\\ce": "\\ce",
        },
      });
      el.dataset.katexRendered = "true";
    }

    function renderAll() {
      console.log("ğŸ¯ å¼€å§‹æ¸²æŸ“æ‰€æœ‰å…ƒç´ ");
      ["front", "back"].forEach((id) => {
        renderMarkdown(id);
        renderMath(id);
      });
    }

    async function init() {
      try {
        console.log("âœ… é¢„è§ˆæ¨¡å¼ï¼Œå¯ç”¨Markdownæ¸²æŸ“å™¨");
        await Promise.all([
          ...RESOURCES.css.map(loadCSS),
          ...RESOURCES.scripts.map(loadScript),
        ]);
        
        // âœ¨ æ‰‹åŠ¨æ³¨å†ŒSvelteè¯­è¨€æ”¯æŒï¼ˆæ°¸ä¹…æ–¹æ¡ˆï¼‰
        if (window.hljs && !window.hljs.getLanguage('svelte')) {
          console.log('ğŸ”§ æ³¨å†ŒSvelteè¯­è¨€å®šä¹‰');
          window.hljs.registerLanguage('svelte', function(hljs) {
            return {
              name: 'Svelte',
              aliases: ['svelte'],
              case_insensitive: false,
              subLanguage: 'xml',
              contains: [
                // Svelteè¡¨è¾¾å¼ {expression}
                {
                  className: 'template-variable',
                  begin: /\{/, end: /\}/,
                  excludeBegin: true,
                  excludeEnd: true,
                  contains: [
                    {
                      subLanguage: 'javascript',
                      begin: /[^}]+/
                    }
                  ]
                },
                // SvelteæŒ‡ä»¤ {#if} {#each} etc
                {
                  className: 'template-tag',
                  begin: /\{[#:/]/, end: /\}/,
                  contains: [
                    {
                      className: 'name',
                      begin: /[#:/]\w+/
                    },
                    {
                      subLanguage: 'javascript',
                      begin: /\s+/, end: /$/
                    }
                  ]
                },
                // HTMLæ³¨é‡Š
                hljs.COMMENT('<!--', '-->', {
                  relevance: 10
                }),
                // HTMLæ ‡ç­¾
                {
                  className: 'tag',
                  begin: /<\/?[A-Za-z_]/, end: />/,
                  contains: [
                    {
                      className: 'name',
                      begin: /[A-Za-z_][\w:]*/
                    },
                    {
                      className: 'attr',
                      begin: /\s[A-Za-z_][\w:]*(?=\s*=)/
                    },
                    {
                      begin: /=/, end: /$/,
                      contains: [
                        hljs.APOS_STRING_MODE,
                        hljs.QUOTE_STRING_MODE,
                        {
                          className: 'template-variable',
                          begin: /\{/, end: /\}/,
                          subLanguage: 'javascript'
                        }
                      ]
                    }
                  ]
                }
              ]
            };
          });
          
          // éªŒè¯æ³¨å†Œå¹¶è®°å½•çŠ¶æ€
          if (window.hljs.getLanguage('svelte')) {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus['svelte.js'] = 'ğŸ”§ æ‰‹åŠ¨æ³¨å†Œ';
            console.log('âœ… Svelteè¯­è¨€æ³¨å†ŒæˆåŠŸï¼Œç°åœ¨å¯ç”¨ï¼');
          } else {
            window.resourceStatus = window.resourceStatus || {};
            window.resourceStatus['svelte.js'] = 'âŒ æ³¨å†Œå¤±è´¥';
            console.log('âŒ Svelteè¯­è¨€æ³¨å†Œå¤±è´¥');
          }
        } else if (window.hljs?.getLanguage?.('svelte')) {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus['svelte.js'] = 'âœ… å·²å­˜åœ¨';
          console.log('âœ… Svelteè¯­è¨€å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ³¨å†Œ');
        } else {
          window.resourceStatus = window.resourceStatus || {};
          window.resourceStatus['svelte.js'] = 'âŒ hljsæœªåŠ è½½';
          console.log('âŒ highlight.jsæœªåŠ è½½ï¼Œæ— æ³•æ³¨å†ŒSvelteè¯­è¨€');
        }
        
        // æ˜¾ç¤ºèµ„æºåŠ è½½çŠ¶æ€
        if (window.resourceStatus) {
          console.log("ğŸ“¦ èµ„æºåŠ è½½çŠ¶æ€:");
          Object.entries(window.resourceStatus).forEach(([resource, status]) => {
            console.log(`   ${resource}: ${status}`);
          });
        }
        
        renderAll();
        console.log("âœ… Markdownæ¸²æŸ“å™¨åˆå§‹åŒ–å®Œæˆ");
      } catch (e) {
        console.error("âŒ Initialization failed:", e);
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      setTimeout(init, 100);
    }
  })();
  }); // ç»“æŸ delayedEditModeCheck å›è°ƒ
</script>
</rewritten_file>
