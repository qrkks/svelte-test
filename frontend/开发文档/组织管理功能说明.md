# 组织管理功能说明

## 概述

本系统实现了完整的三级权限管理架构，包括主组织管理和子组织管理功能。所有页面都使用Svelte 5的runes语法开发。

## 功能模块

### 1. 主组织管理 (`/settings/admin/organizations`)

#### 功能特性
- **组织列表展示**: 显示所有主组织，包括名称、类型、状态、描述和创建时间
- **创建组织**: 支持创建新的主组织，可选择组织类型（协会、公司、集团）
- **编辑组织**: 修改现有组织的信息
- **删除组织**: 安全删除组织（检查依赖关系）
- **状态管理**: 支持活跃、非活跃、暂停三种状态

#### 组织类型
- `association`: 协会
- `company`: 公司  
- `group`: 集团

#### 状态类型
- `active`: 活跃
- `inactive`: 非活跃
- `suspended`: 暂停

### 2. 子组织管理 (`/settings/admin/organizations/[id]/sub-organizations`)

#### 功能特性
- **子组织列表**: 显示指定主组织下的所有子组织
- **创建子组织**: 在指定主组织下创建子组织
- **编辑子组织**: 修改子组织信息
- **删除子组织**: 安全删除子组织
- **面包屑导航**: 显示组织层级关系

#### 子组织类型
- `committee`: 专委会
- `department`: 部门
- `subsidiary`: 子公司

### 3. 权限测试 (`/settings/admin/permission-test`)

#### 功能特性
- **权限验证测试**: 测试特定用户对特定权限的访问权限
- **上下文测试**: 支持在特定组织和子组织上下文中测试权限
- **权限信息展示**: 显示当前用户的所有权限信息
- **权限层级展示**: 清晰展示系统权限、组织权限、子组织权限的层级关系

#### 测试功能
- 选择用户、权限、组织上下文
- 实时显示测试结果
- 详细的权限来源追踪

### 4. 权限组件

#### PermissionButton 组件
```svelte
<PermissionButton 
  permission="organization:manage" 
  organizationId={1}
  class="bg-blue-600 text-white"
>
  管理组织
</PermissionButton>
```

#### OrganizationSwitcher 组件
```svelte
<OrganizationSwitcher 
  currentOrganizationId={1} 
  showLabel={true} 
/>
```

## 技术实现

### 数据库设计
- **organization**: 主组织表
- **sub_organization**: 子组织表
- **organization_role**: 主组织角色表
- **sub_organization_role**: 子组织角色表
- **user_organization_role**: 用户-主组织-角色关联表
- **user_sub_organization_role**: 用户-子组织-角色关联表

### 权限验证
- 三级权限验证：系统权限 > 主组织权限 > 子组织权限
- 权限继承：上级权限可以覆盖下级权限
- 组织隔离：用户只能访问自己所属的组织

### 前端技术
- **Svelte 5 Runes**: 使用最新的响应式语法
- **Tailwind CSS**: 现代化UI设计
- **渐进式增强**: 支持无JavaScript环境
- **表单验证**: 客户端和服务器端双重验证

## 使用流程

### 1. 创建组织架构
1. 访问 `/settings/admin/organizations`
2. 点击"创建组织"按钮
3. 填写组织信息（名称、类型、描述等）
4. 保存创建

### 2. 管理子组织
1. 在组织列表中点击"子组织"链接
2. 在子组织页面点击"创建子组织"
3. 选择子组织类型和填写信息
4. 保存创建

### 3. 测试权限
1. 访问 `/settings/admin/permission-test`
2. 选择要测试的用户和权限
3. 可选择组织上下文
4. 点击"测试权限"查看结果

## 安全特性

### 数据验证
- 服务器端表单验证
- SQL注入防护
- XSS攻击防护

### 权限控制
- 基于角色的访问控制
- 组织级别的数据隔离
- 操作审计日志

### 依赖检查
- 删除组织前检查子组织依赖
- 删除组织前检查用户关联
- 防止级联删除导致的数据丢失

## 扩展功能

### 待实现功能
- **权限审计日志**: 记录权限变更历史
- **权限模板**: 预定义权限组合
- **批量操作**: 批量创建和管理组织
- **组织架构图**: 可视化组织层级关系
- **权限继承配置**: 自定义权限继承规则

### 集成功能
- **审批流程**: 基于权限的审批系统
- **通知系统**: 权限变更通知
- **报表统计**: 权限使用统计
- **API接口**: 对外提供权限管理API

## 开发规范

### 代码规范
- 使用Svelte 5 runes语法
- 遵循TypeScript类型定义
- 组件化开发
- 响应式设计

### 文件结构
```
frontend/src/routes/settings/admin/
├── organizations/
│   ├── +page.server.js
│   ├── +page.svelte
│   └── [id]/
│       └── sub-organizations/
│           ├── +page.server.js
│           └── +page.svelte
├── permission-test/
│   ├── +page.server.js
│   └── +page.svelte
└── +page.svelte
```

### 组件库
```
frontend/src/lib/components/ui/
├── PermissionButton.svelte
├── OrganizationSwitcher.svelte
├── ConfirmDialog.svelte
└── Toast.svelte
```

## 测试建议

### 功能测试
1. 创建、编辑、删除组织
2. 权限验证测试
3. 组织切换功能
4. 错误处理测试

### 性能测试
1. 大量组织数据加载
2. 权限验证响应时间
3. 并发用户访问

### 安全测试
1. 权限绕过测试
2. 数据泄露测试
3. 注入攻击测试

## 部署注意事项

### 环境配置
- 确保数据库连接正常
- 配置正确的权限设置
- 设置适当的缓存策略

### 数据迁移
- 运行数据库迁移脚本
- 创建初始组织数据
- 设置默认权限配置

### 监控告警
- 监控权限验证性能
- 设置异常操作告警
- 记录权限变更日志 