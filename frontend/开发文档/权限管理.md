# 三级权限系统完整开发文档

## 0. 开发规则

使用svelte5 新版runes语法。
[text](llms/sveltekit-llms-small.md)

## 1. 系统概述

### 1.1 权限层级

- **系统角色**（最高级）：系统管理员、超级管理员等
- **主组织角色**（中间级）：协会会长、副会长、秘书长等
- **子组织角色**（最低级）：专委会主席、委员、秘书等

### 1.2 设计原则

- 支持多主组织架构
- 权限继承：上级权限可以覆盖下级
- 组织隔离：用户只能访问自己所属的组织
- 灵活配置：通过配置文件控制不同项目的差异

## 2. 数据库设计

### 2.1 完整数据库DBML

```sql
-- 用户表
Table user {
  id integer [primary key, increment]
  username text [not null, unique]
  password text [not null, note: "明文密码，仅开发环境使用"]
  password_hash text [not null]
  mobile text [unique]
  email text [unique]
  age integer
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  last_login_at timestamp
}

-- 会话表
Table session {
  id text [primary key]
  user_id integer [not null, ref: > user.id]
  expires_at timestamp [not null]
}

-- 主组织表（可以是协会、公司、集团等）
Table organization {
  id integer [primary key, increment]
  name text [not null, unique]
  type text [not null, note: "association/company/group"]
  description text
  status text [not null, default: 'active']
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
}

-- 主组织角色表
Table organization_role {
  id integer [primary key, increment]
  name text [not null, unique, note: "会长、CEO、总裁等"]
  description text
  created_at timestamp [not null, default: `now()`]
}

-- 用户-主组织-角色关联表
Table user_organization_role {
  user_id integer [not null, ref: > user.id]
  organization_id integer [not null, ref: > organization.id]
  organization_role_id integer [not null, ref: > organization_role.id]

  indexes {
    (user_id, organization_id, organization_role_id) [pk]
  }
}

-- 主组织角色-权限关联表
Table organization_role_permission {
  organization_role_id integer [not null, ref: > organization_role.id]
  permission text [not null, note: "如：organization:manage, sub_organization:create"]

  indexes {
    (organization_role_id, permission) [pk]
  }
}

-- 子组织表（关联到主组织）
Table sub_organization {
  id integer [primary key, increment]
  name text [not null, unique]
  organization_id integer [not null, ref: > organization.id, note: "所属主组织"]
  type text [not null, note: "committee/department/subsidiary"]
  description text
  status text [not null, default: 'active']
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
}

-- 子组织角色表
Table sub_organization_role {
  id integer [primary key, increment]
  name text [not null, unique, note: "主席、经理、总监等"]
  description text
  created_at timestamp [not null, default: `now()`]
}

-- 用户-子组织-角色关联表
Table user_sub_organization_role {
  user_id integer [not null, ref: > user.id]
  sub_organization_id integer [not null, ref: > sub_organization.id]
  sub_organization_role_id integer [not null, ref: > sub_organization_role.id]

  indexes {
    (user_id, sub_organization_id, sub_organization_role_id) [pk]
  }
}

-- 子组织角色-权限关联表
Table sub_organization_role_permission {
  sub_organization_role_id integer [not null, ref: > sub_organization_role.id]
  permission text [not null, note: "如：sub_organization:approve, sub_organization:view"]

  indexes {
    (sub_organization_role_id, permission) [pk]
  }
}

-- 系统角色表
Table system_role {
  id integer [primary key, increment]
  name text [not null, unique, note: "admin/super_admin"]
  description text
  created_at timestamp [not null, default: `now()`]
}

-- 用户-系统角色关联表
Table user_system_role {
  user_id integer [not null, ref: > user.id]
  system_role_id integer [not null, ref: > system_role.id]

  indexes {
    (user_id, system_role_id) [pk]
  }
}

-- 系统角色-权限关联表
Table system_role_permission {
  system_role_id integer [not null, ref: > system_role.id]
  permission text [not null, note: "如：system:admin, system:config"]

  indexes {
    (system_role_id, permission) [pk]
  }
}
```

### 2.2 权限命名规范

```javascript
// 权限命名规范
const PERMISSION_PATTERNS = {
	// 系统级权限
	system: [
		'system:admin', // 系统管理
		'system:config', // 系统配置
		'system:user_manage' // 用户管理
	],

	// 主组织级权限
	organization: [
		'organization:manage', // 组织管理
		'organization:view', // 组织查看
		'organization:edit', // 组织编辑
		'sub_organization:create', // 创建子组织
		'sub_organization:manage', // 管理子组织
		'sub_organization:view' // 查看子组织
	],

	// 子组织级权限
	subOrganization: [
		'sub_organization:manage', // 子组织管理
		'sub_organization:view', // 子组织查看
		'sub_organization:edit', // 子组织编辑
		'sub_organization:approve', // 子组织审批
		'sub_organization:delete' // 子组织删除
	]
};
```

## 3. 开发顺序

### 3.1 第一阶段：数据库和基础权限系统

#### 3.1.1 更新数据库Schema

```javascript
// frontend/src/lib/server/db/schema.js
import { sqliteTable, integer, text, unique } from 'drizzle-orm/sqlite-core';

// 添加新的表定义
export const organization = sqliteTable('organization', {
	id: integer('id').primaryKey({ autoIncrement: true }),
	name: text('name').notNull().unique(),
	type: text('type').notNull(),
	description: text('description'),
	status: text('status').notNull().default('active'),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow(),
	updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull().defaultNow()
});

export const organizationRole = sqliteTable('organization_role', {
	id: integer('id').primaryKey({ autoIncrement: true }),
	name: text('name').notNull().unique(),
	description: text('description'),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow()
});

export const userOrganizationRole = sqliteTable(
	'user_organization_role',
	{
		userId: integer('user_id')
			.notNull()
			.references(() => user.id),
		organizationId: integer('organization_id')
			.notNull()
			.references(() => organization.id),
		organizationRoleId: integer('organization_role_id')
			.notNull()
			.references(() => organizationRole.id)
	},
	(table) => ({
		pk: unique('user_organization_role_pk').on(
			table.userId,
			table.organizationId,
			table.organizationRoleId
		)
	})
);

export const organizationRolePermission = sqliteTable(
	'organization_role_permission',
	{
		organizationRoleId: integer('organization_role_id')
			.notNull()
			.references(() => organizationRole.id),
		permission: text('permission').notNull()
	},
	(table) => ({
		pk: unique('organization_role_permission_pk').on(table.organizationRoleId, table.permission)
	})
);

export const subOrganization = sqliteTable('sub_organization', {
	id: integer('id').primaryKey({ autoIncrement: true }),
	name: text('name').notNull().unique(),
	organizationId: integer('organization_id')
		.notNull()
		.references(() => organization.id),
	type: text('type').notNull(),
	description: text('description'),
	status: text('status').notNull().default('active'),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow(),
	updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull().defaultNow()
});

export const subOrganizationRole = sqliteTable('sub_organization_role', {
	id: integer('id').primaryKey({ autoIncrement: true }),
	name: text('name').notNull().unique(),
	description: text('description'),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow()
});

export const userSubOrganizationRole = sqliteTable(
	'user_sub_organization_role',
	{
		userId: integer('user_id')
			.notNull()
			.references(() => user.id),
		subOrganizationId: integer('sub_organization_id')
			.notNull()
			.references(() => subOrganization.id),
		subOrganizationRoleId: integer('sub_organization_role_id')
			.notNull()
			.references(() => subOrganizationRole.id)
	},
	(table) => ({
		pk: unique('user_sub_organization_role_pk').on(
			table.userId,
			table.subOrganizationId,
			table.subOrganizationRoleId
		)
	})
);

export const subOrganizationRolePermission = sqliteTable(
	'sub_organization_role_permission',
	{
		subOrganizationRoleId: integer('sub_organization_role_id')
			.notNull()
			.references(() => subOrganizationRole.id),
		permission: text('permission').notNull()
	},
	(table) => ({
		pk: unique('sub_organization_role_permission_pk').on(
			table.subOrganizationRoleId,
			table.permission
		)
	})
);

export const systemRole = sqliteTable('system_role', {
	id: integer('id').primaryKey({ autoIncrement: true }),
	name: text('name').notNull().unique(),
	description: text('description'),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow()
});

export const userSystemRole = sqliteTable(
	'user_system_role',
	{
		userId: integer('user_id')
			.notNull()
			.references(() => user.id),
		systemRoleId: integer('system_role_id')
			.notNull()
			.references(() => systemRole.id)
	},
	(table) => ({
		pk: unique('user_system_role_pk').on(table.userId, table.systemRoleId)
	})
);

export const systemRolePermission = sqliteTable(
	'system_role_permission',
	{
		systemRoleId: integer('system_role_id')
			.notNull()
			.references(() => systemRole.id),
		permission: text('permission').notNull()
	},
	(table) => ({
		pk: unique('system_role_permission_pk').on(table.systemRoleId, table.permission)
	})
);
```

#### 3.1.2 创建权限验证服务

```javascript
// frontend/src/lib/server/permissions.js
import { eq, and } from 'drizzle-orm';
import { db } from '$lib/server/db';
import * as table from '$lib/server/db/schema';

/**
 * 三级权限验证函数
 * @param {number} userId - 用户ID
 * @param {string} permission - 权限字符串
 * @param {Object} context - 上下文对象
 * @param {number} context.organizationId - 主组织ID
 * @param {number} context.subOrganizationId - 子组织ID
 * @returns {Promise<boolean>} 是否有权限
 */
export async function checkUserPermission(userId, permission, context = {}) {
	const { organizationId, subOrganizationId } = context;

	// 1. 检查用户系统角色权限（最高级）
	const systemPermissions = await getUserSystemPermissions(userId);
	if (systemPermissions.includes(permission)) {
		return true;
	}

	// 2. 检查主组织角色权限（中间级）
	if (organizationId) {
		const organizationPermissions = await getUserOrganizationPermissions(userId, organizationId);
		if (organizationPermissions.includes(permission)) {
			return true;
		}
	}

	// 3. 检查子组织角色权限（最低级）
	if (subOrganizationId) {
		const subOrganizationPermissions = await getUserSubOrganizationPermissions(
			userId,
			subOrganizationId
		);
		if (subOrganizationPermissions.includes(permission)) {
			return true;
		}
	}

	return false;
}

/**
 * 获取用户系统权限
 */
export async function getUserSystemPermissions(userId) {
	const result = await db
		.select({ permission: table.systemRolePermission.permission })
		.from(table.userSystemRole)
		.innerJoin(
			table.systemRolePermission,
			eq(table.userSystemRole.systemRoleId, table.systemRolePermission.systemRoleId)
		)
		.where(eq(table.userSystemRole.userId, userId));

	return result.map((r) => r.permission);
}

/**
 * 获取用户主组织权限
 */
export async function getUserOrganizationPermissions(userId, organizationId) {
	const result = await db
		.select({ permission: table.organizationRolePermission.permission })
		.from(table.userOrganizationRole)
		.innerJoin(
			table.organizationRolePermission,
			eq(
				table.userOrganizationRole.organizationRoleId,
				table.organizationRolePermission.organizationRoleId
			)
		)
		.where(
			and(
				eq(table.userOrganizationRole.userId, userId),
				eq(table.userOrganizationRole.organizationId, organizationId)
			)
		);

	return result.map((r) => r.permission);
}

/**
 * 获取用户子组织权限
 */
export async function getUserSubOrganizationPermissions(userId, subOrganizationId) {
	const result = await db
		.select({ permission: table.subOrganizationRolePermission.permission })
		.from(table.userSubOrganizationRole)
		.innerJoin(
			table.subOrganizationRolePermission,
			eq(
				table.userSubOrganizationRole.subOrganizationRoleId,
				table.subOrganizationRolePermission.subOrganizationRoleId
			)
		)
		.where(
			and(
				eq(table.userSubOrganizationRole.userId, userId),
				eq(table.userSubOrganizationRole.subOrganizationId, subOrganizationId)
			)
		);

	return result.map((r) => r.permission);
}

/**
 * 获取用户所属的所有主组织
 */
export async function getUserOrganizations(userId) {
	const result = await db
		.select({
			organizationId: table.organization.id,
			organizationName: table.organization.name,
			organizationType: table.organization.type,
			roleName: table.organizationRole.name,
			roleDescription: table.organizationRole.description
		})
		.from(table.userOrganizationRole)
		.innerJoin(
			table.organization,
			eq(table.userOrganizationRole.organizationId, table.organization.id)
		)
		.innerJoin(
			table.organizationRole,
			eq(table.userOrganizationRole.organizationRoleId, table.organizationRole.id)
		)
		.where(eq(table.userOrganizationRole.userId, userId));

	return result;
}

/**
 * 获取用户所属的所有子组织
 */
export async function getUserSubOrganizations(userId, organizationId = null) {
	let query = db
		.select({
			subOrganizationId: table.subOrganization.id,
			subOrganizationName: table.subOrganization.name,
			subOrganizationType: table.subOrganization.type,
			organizationId: table.subOrganization.organizationId,
			organizationName: table.organization.name,
			roleName: table.subOrganizationRole.name,
			roleDescription: table.subOrganizationRole.description
		})
		.from(table.userSubOrganizationRole)
		.innerJoin(
			table.subOrganization,
			eq(table.userSubOrganizationRole.subOrganizationId, table.subOrganization.id)
		)
		.innerJoin(table.organization, eq(table.subOrganization.organizationId, table.organization.id))
		.innerJoin(
			table.subOrganizationRole,
			eq(table.userSubOrganizationRole.subOrganizationRoleId, table.subOrganizationRole.id)
		)
		.where(eq(table.userSubOrganizationRole.userId, userId));

	if (organizationId) {
		query = query.where(eq(table.subOrganization.organizationId, organizationId));
	}

	const result = await query;
	return result;
}
```

#### 3.1.3 创建权限中间件

```javascript
// frontend/src/lib/server/middleware/permissions.js
import { redirect } from '@sveltejs/kit';
import { checkUserPermission } from '$lib/server/permissions';

/**
 * 权限验证中间件
 * @param {string} permission - 所需权限
 * @param {Object} context - 上下文对象
 * @returns {Function} 中间件函数
 */
export function requirePermission(permission, context = {}) {
	return async ({ locals, url }) => {
		if (!locals.user) {
			throw redirect(302, '/settings/auth/login');
		}

		const hasPermission = await checkUserPermission(locals.user.id, permission, context);

		if (!hasPermission) {
			throw redirect(302, '/settings/auth/login?error=insufficient_permissions');
		}
	};
}

/**
 * 组织权限验证中间件
 * @param {string} permission - 所需权限
 * @returns {Function} 中间件函数
 */
export function requireOrganizationPermission(permission) {
	return async ({ locals, params, url }) => {
		if (!locals.user) {
			throw redirect(302, '/settings/auth/login');
		}

		const organizationId = parseInt(params.organizationId);
		if (!organizationId) {
			throw redirect(302, '/settings/auth/login?error=invalid_organization');
		}

		const hasPermission = await checkUserPermission(locals.user.id, permission, { organizationId });

		if (!hasPermission) {
			throw redirect(302, '/settings/auth/login?error=insufficient_permissions');
		}
	};
}

/**
 * 子组织权限验证中间件
 * @param {string} permission - 所需权限
 * @returns {Function} 中间件函数
 */
export function requireSubOrganizationPermission(permission) {
	return async ({ locals, params, url }) => {
		if (!locals.user) {
			throw redirect(302, '/settings/auth/login');
		}

		const organizationId = parseInt(params.organizationId);
		const subOrganizationId = parseInt(params.subOrganizationId);

		if (!organizationId || !subOrganizationId) {
			throw redirect(302, '/settings/auth/login?error=invalid_organization');
		}

		const hasPermission = await checkUserPermission(locals.user.id, permission, {
			organizationId,
			subOrganizationId
		});

		if (!hasPermission) {
			throw redirect(302, '/settings/auth/login?error=insufficient_permissions');
		}
	};
}
```

### 3.2 第二阶段：前端权限组件

#### 3.2.1 创建权限Store

```javascript
// frontend/src/lib/state/permissions.svelte.js
import { writable, derived } from 'svelte/store';
import { getUserOrganizations, getUserSubOrganizations } from '$lib/server/permissions';

export const currentOrganization = writable(null);
export const currentSubOrganization = writable(null);
export const userOrganizations = writable([]);
export const userSubOrganizations = writable([]);

// 初始化权限数据
export async function initializePermissions(userId) {
	const orgs = await getUserOrganizations(userId);
	userOrganizations.set(orgs);

	if (orgs.length > 0) {
		currentOrganization.set(orgs[0]);

		const subOrgs = await getUserSubOrganizations(userId, orgs[0].organizationId);
		userSubOrganizations.set(subOrgs);
	}
}

// 切换主组织
export async function switchOrganization(organization, userId) {
	currentOrganization.set(organization);

	const subOrgs = await getUserSubOrganizations(userId, organization.organizationId);
	userSubOrganizations.set(subOrgs);

	// 重置子组织选择
	currentSubOrganization.set(null);
}

// 切换子组织
export function switchSubOrganization(subOrganization) {
	currentSubOrganization.set(subOrganization);
}

// 当前权限上下文
export const currentPermissionContext = derived(
	[currentOrganization, currentSubOrganization],
	([$currentOrganization, $currentSubOrganization]) => ({
		organizationId: $currentOrganization?.organizationId,
		subOrganizationId: $currentSubOrganization?.subOrganizationId
	})
);
```

#### 3.2.2 创建权限按钮组件

```svelte
<!-- frontend/src/lib/components/ui/PermissionButton.svelte -->
<script>
	import { checkUserPermission } from '$lib/server/permissions';
	import { currentPermissionContext } from '$lib/state/permissions.svelte.js';

	export let permission;
	export let organizationId = null;
	export let subOrganizationId = null;
	export let fallback = null;
	export let disabled = false;
	export let loading = false;

	let hasPermission = false;
	let checking = false;

	$: {
		checkPermission();
	}

	async function checkPermission() {
		if (checking) return;

		checking = true;
		try {
			const context = {
				organizationId: organizationId || $currentPermissionContext.organizationId,
				subOrganizationId: subOrganizationId || $currentPermissionContext.subOrganizationId
			};

			hasPermission = await checkUserPermission($user.id, permission, context);
		} catch (error) {
			console.error('权限检查失败:', error);
			hasPermission = false;
		} finally {
			checking = false;
		}
	}
</script>

{#if hasPermission}
	<button {disabled} {loading} on:click class="permission-button">
		<slot />
	</button>
{:else if fallback}
	{fallback}
{/if}

<style>
	.permission-button {
		/* 按钮样式 */
	}
</style>
```

#### 3.2.3 创建组织切换器组件

```svelte
<!-- frontend/src/lib/components/navigation/OrganizationSwitcher.svelte -->
<script>
	import {
		currentOrganization,
		userOrganizations,
		switchOrganization
	} from '$lib/state/permissions.svelte.js';

	export let userId;

	async function handleOrganizationChange(event) {
		const organizationId = parseInt(event.target.value);
		const organization = $userOrganizations.find((org) => org.organizationId === organizationId);

		if (organization) {
			await switchOrganization(organization, userId);
		}
	}
</script>

{#if $userOrganizations.length > 1}
	<div class="organization-switcher">
		<label for="organization-select">当前组织：</label>
		<select
			id="organization-select"
			value={$currentOrganization?.organizationId}
			on:change={handleOrganizationChange}
		>
			{#each $userOrganizations as org}
				<option value={org.organizationId}>
					{org.organizationName} - {org.roleName}
				</option>
			{/each}
		</select>
	</div>
{/if}

<style>
	.organization-switcher {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem;
		background: var(--color-background-soft);
		border-radius: 0.5rem;
	}

	.organization-switcher select {
		padding: 0.25rem 0.5rem;
		border: 1px solid var(--color-border);
		border-radius: 0.25rem;
		background: var(--color-background);
		color: var(--color-text);
	}
</style>
```

### 3.3 第三阶段：权限管理界面

#### 3.3.1 角色管理页面

```svelte
<!-- frontend/src/routes/settings/roles/+page.svelte -->
<script>
	import { onMount } from 'svelte';
	import { db } from '$lib/server/db';
	import * as table from '$lib/server/db/schema';

	let systemRoles = [];
	let organizationRoles = [];
	let subOrganizationRoles = [];
	let loading = true;

	onMount(async () => {
		await loadRoles();
		loading = false;
	});

	async function loadRoles() {
		// 加载系统角色
		systemRoles = await db.select().from(table.systemRole);

		// 加载主组织角色
		organizationRoles = await db.select().from(table.organizationRole);

		// 加载子组织角色
		subOrganizationRoles = await db.select().from(table.subOrganizationRole);
	}

	async function createRole(type, name, description) {
		let newRole;

		switch (type) {
			case 'system':
				newRole = await db.insert(table.systemRole).values({ name, description });
				break;
			case 'organization':
				newRole = await db.insert(table.organizationRole).values({ name, description });
				break;
			case 'subOrganization':
				newRole = await db.insert(table.subOrganizationRole).values({ name, description });
				break;
		}

		await loadRoles();
	}
</script>

<svelte:head>
	<title>角色管理</title>
</svelte:head>

<div class="roles-page">
	<h1>角色管理</h1>

	{#if loading}
		<div class="loading">加载中...</div>
	{:else}
		<div class="roles-grid">
			<!-- 系统角色 -->
			<div class="role-section">
				<h2>系统角色</h2>
				<div class="role-list">
					{#each systemRoles as role}
						<div class="role-item">
							<h3>{role.name}</h3>
							<p>{role.description}</p>
						</div>
					{/each}
				</div>
			</div>

			<!-- 主组织角色 -->
			<div class="role-section">
				<h2>主组织角色</h2>
				<div class="role-list">
					{#each organizationRoles as role}
						<div class="role-item">
							<h3>{role.name}</h3>
							<p>{role.description}</p>
						</div>
					{/each}
				</div>
			</div>

			<!-- 子组织角色 -->
			<div class="role-section">
				<h2>子组织角色</h2>
				<div class="role-list">
					{#each subOrganizationRoles as role}
						<div class="role-item">
							<h3>{role.name}</h3>
							<p>{role.description}</p>
						</div>
					{/each}
				</div>
			</div>
		</div>
	{/if}
</div>

<style>
	.roles-page {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem;
	}

	.roles-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 2rem;
		margin-top: 2rem;
	}

	.role-section {
		background: var(--color-background-soft);
		padding: 1.5rem;
		border-radius: 0.5rem;
	}

	.role-list {
		margin-top: 1rem;
	}

	.role-item {
		background: var(--color-background);
		padding: 1rem;
		margin-bottom: 0.5rem;
		border-radius: 0.25rem;
		border: 1px solid var(--color-border);
	}
</style>
```

#### 3.3.2 权限分配页面

```svelte
<!-- frontend/src/routes/settings/permissions/+page.svelte -->
<script>
	import { onMount } from 'svelte';
	import { db } from '$lib/server/db';
	import * as table from '$lib/server/db/schema';

	let roles = [];
	let permissions = [];
	let rolePermissions = {};
	let loading = true;

	onMount(async () => {
		await loadData();
		loading = false;
	});

	async function loadData() {
		// 加载所有角色
		const systemRoles = await db.select().from(table.systemRole);
		const organizationRoles = await db.select().from(table.organizationRole);
		const subOrganizationRoles = await db.select().from(table.subOrganizationRole);

		roles = [
			...systemRoles.map((r) => ({ ...r, type: 'system' })),
			...organizationRoles.map((r) => ({ ...r, type: 'organization' })),
			...subOrganizationRoles.map((r) => ({ ...r, type: 'subOrganization' }))
		];

		// 加载所有权限
		permissions = [
			// 系统权限
			'system:admin',
			'system:config',
			'system:user_manage',

			// 主组织权限
			'organization:manage',
			'organization:view',
			'organization:edit',
			'sub_organization:create',
			'sub_organization:manage',
			'sub_organization:view',

			// 子组织权限
			'sub_organization:manage',
			'sub_organization:view',
			'sub_organization:edit',
			'sub_organization:approve',
			'sub_organization:delete'
		];

		// 加载角色权限映射
		await loadRolePermissions();
	}

	async function loadRolePermissions() {
		// 加载系统角色权限
		const systemRolePermissions = await db.select().from(table.systemRolePermission);

		// 加载主组织角色权限
		const organizationRolePermissions = await db.select().from(table.organizationRolePermission);

		// 加载子组织角色权限
		const subOrganizationRolePermissions = await db
			.select()
			.from(table.subOrganizationRolePermission);

		// 构建权限映射
		rolePermissions = {};

		systemRolePermissions.forEach((rp) => {
			if (!rolePermissions[rp.systemRoleId]) {
				rolePermissions[rp.systemRoleId] = [];
			}
			rolePermissions[rp.systemRoleId].push(rp.permission);
		});

		organizationRolePermissions.forEach((rp) => {
			if (!rolePermissions[rp.organizationRoleId]) {
				rolePermissions[rp.organizationRoleId] = [];
			}
			rolePermissions[rp.organizationRoleId].push(rp.permission);
		});

		subOrganizationRolePermissions.forEach((rp) => {
			if (!rolePermissions[rp.subOrganizationRoleId]) {
				rolePermissions[rp.subOrganizationRoleId] = [];
			}
			rolePermissions[rp.subOrganizationRoleId].push(rp.permission);
		});
	}

	async function togglePermission(roleId, permission) {
		const role = roles.find((r) => r.id === roleId);
		if (!role) return;

		const hasPermission = rolePermissions[roleId]?.includes(permission);

		if (hasPermission) {
			// 移除权限
			switch (role.type) {
				case 'system':
					await db
						.delete(table.systemRolePermission)
						.where(
							and(
								eq(table.systemRolePermission.systemRoleId, roleId),
								eq(table.systemRolePermission.permission, permission)
							)
						);
					break;
				case 'organization':
					await db
						.delete(table.organizationRolePermission)
						.where(
							and(
								eq(table.organizationRolePermission.organizationRoleId, roleId),
								eq(table.organizationRolePermission.permission, permission)
							)
						);
					break;
				case 'subOrganization':
					await db
						.delete(table.subOrganizationRolePermission)
						.where(
							and(
								eq(table.subOrganizationRolePermission.subOrganizationRoleId, roleId),
								eq(table.subOrganizationRolePermission.permission, permission)
							)
						);
					break;
			}
		} else {
			// 添加权限
			switch (role.type) {
				case 'system':
					await db.insert(table.systemRolePermission).values({ systemRoleId: roleId, permission });
					break;
				case 'organization':
					await db
						.insert(table.organizationRolePermission)
						.values({ organizationRoleId: roleId, permission });
					break;
				case 'subOrganization':
					await db
						.insert(table.subOrganizationRolePermission)
						.values({ subOrganizationRoleId: roleId, permission });
					break;
			}
		}

		await loadRolePermissions();
	}
</script>

<svelte:head>
	<title>权限分配</title>
</svelte:head>

<div class="permissions-page">
	<h1>权限分配</h1>

	{#if loading}
		<div class="loading">加载中...</div>
	{:else}
		<div class="permissions-table">
			<table>
				<thead>
					<tr>
						<th>角色</th>
						{#each permissions as permission}
							<th>{permission}</th>
						{/each}
					</tr>
				</thead>
				<tbody>
					{#each roles as role}
						<tr>
							<td>
								<strong>{role.name}</strong>
								<br />
								<small>{role.type}</small>
							</td>
							{#each permissions as permission}
								<td>
									<input
										type="checkbox"
										checked={rolePermissions[role.id]?.includes(permission)}
										on:change={() => togglePermission(role.id, permission)}
									/>
								</td>
							{/each}
						</tr>
					{/each}
				</tbody>
			</table>
		</div>
	{/if}
</div>

<style>
	.permissions-page {
		max-width: 100%;
		margin: 0 auto;
		padding: 2rem;
		overflow-x: auto;
	}

	.permissions-table table {
		width: 100%;
		border-collapse: collapse;
		background: var(--color-background);
		border-radius: 0.5rem;
		overflow: hidden;
	}

	.permissions-table th,
	.permissions-table td {
		padding: 0.75rem;
		text-align: left;
		border-bottom: 1px solid var(--color-border);
	}

	.permissions-table th {
		background: var(--color-background-soft);
		font-weight: 600;
	}

	.permissions-table input[type='checkbox'] {
		width: 1rem;
		height: 1rem;
	}
</style>
```

### 3.4 第四阶段：组织管理界面

#### 3.4.1 主组织管理页面

```svelte
<!-- frontend/src/routes/organizations/+page.svelte -->
<script>
	import { onMount } from 'svelte';
	import { db } from '$lib/server/db';
	import * as table from '$lib/server/db/schema';
	import PermissionButton from '$lib/components/ui/PermissionButton.svelte';

	let organizations = [];
	let loading = true;

	onMount(async () => {
		await loadOrganizations();
		loading = false;
	});

	async function loadOrganizations() {
		organizations = await db.select().from(table.organization);
	}

	async function createOrganization(name, type, description) {
		await db.insert(table.organization).values({
			name,
			type,
			description
		});

		await loadOrganizations();
	}
</script>

<svelte:head>
	<title>主组织管理</title>
</svelte:head>

<div class="organizations-page">
	<div class="page-header">
		<h1>主组织管理</h1>
		<PermissionButton permission="organization:create">
			<button class="btn-primary">创建组织</button>
		</PermissionButton>
	</div>

	{#if loading}
		<div class="loading">加载中...</div>
	{:else}
		<div class="organizations-grid">
			{#each organizations as org}
				<div class="organization-card">
					<h3>{org.name}</h3>
					<p class="org-type">{org.type}</p>
					<p class="org-description">{org.description}</p>
					<div class="org-actions">
						<PermissionButton permission="organization:view" organizationId={org.id}>
							<button class="btn-secondary">查看</button>
						</PermissionButton>
						<PermissionButton permission="organization:edit" organizationId={org.id}>
							<button class="btn-secondary">编辑</button>
						</PermissionButton>
					</div>
				</div>
			{/each}
		</div>
	{/if}
</div>

<style>
	.organizations-page {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem;
	}

	.page-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
	}

	.organizations-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		gap: 1.5rem;
	}

	.organization-card {
		background: var(--color-background-soft);
		padding: 1.5rem;
		border-radius: 0.5rem;
		border: 1px solid var(--color-border);
	}

	.org-type {
		color: var(--color-text-muted);
		font-size: 0.875rem;
		margin: 0.5rem 0;
	}

	.org-description {
		margin: 1rem 0;
		line-height: 1.5;
	}

	.org-actions {
		display: flex;
		gap: 0.5rem;
		margin-top: 1rem;
	}

	.btn-primary {
		background: var(--color-primary);
		color: white;
		border: none;
		padding: 0.5rem 1rem;
		border-radius: 0.25rem;
		cursor: pointer;
	}

	.btn-secondary {
		background: var(--color-background);
		color: var(--color-text);
		border: 1px solid var(--color-border);
		padding: 0.5rem 1rem;
		border-radius: 0.25rem;
		cursor: pointer;
	}
</style>
```

### 3.5 第五阶段：用户角色分配

#### 3.5.1 用户角色管理页面

````svelte
<!-- frontend/src/routes/settings/users/roles/+page.svelte -->
<script>
	import { onMount } from 'svelte';
	import { db } from '$lib/server/db';
	import * as table from '$lib/server/db/schema';

	let users = [];
	let roles = [];
	let userRoles = {};
	let loading = true;

	onMount(async () => {
		await loadData();
		loading = false;
	});

	async function loadData() {
		// 加载用户
		users = await db.select().from(table.user);

		// 加载角色
		const systemRoles = await db.select().from(table.systemRole);
		const organizationRoles = await db.select().from(table.organizationRole);
		const subOrganizationRoles = await db.select().from(table.subOrganizationRole);

		roles = [
			...systemRoles.map((r) => ({ ...r, type: 'system' })),
			...organizationRoles.map((r) => ({ ...r, type: 'organization' })),
			...subOrganizationRoles.map((r) => ({ ...r, type: 'subOrganization' }))
		];

		// 加载用户角色映射
		await loadUserRoles();
	}

	async function loadUserRoles() {
		// 加载系统角色分配
		const userSystemRoles = await db.select().from(table.userSystemRole);

		// 加载主组织角色分配
		const userOrganizationRoles = await db.select().from(table.userOrganizationRole);

		// 加载子组织角色分配
		const userSubOrganizationRoles = await db.select().from(table.userSubOrganizationRole);

		// 构建用户角色映射
		userRoles = {};

		userSystemRoles.forEach((ur) => {
			if (!userRoles[ur.userId]) {
				userRoles[ur.userId] = { system: [], organization: [], subOrganization: [] };
			}
			userRoles[ur.userId].system.push(ur.systemRoleId);
		});

		userOrganizationRoles.forEach((ur) => {
			if (!userRoles[ur.userId]) {
				userRoles[ur.userId] = { system: [], organization: [], subOrganization: [] };
			}
			userRoles[ur.userId].organization.push({
				organizationId: ur.organizationId,
				roleId: ur.organizationRoleId
			});
		});

		userSubOrganizationRoles.forEach((ur) => {
			if (!userRoles[ur.userId]) {
				userRoles[ur.userId] = { system: [], organization: [], subOrganization: [] };
			}
			userRoles[ur.userId].subOrganization.push({
				subOrganizationId: ur.subOrganizationId,
				roleId: ur.subOrganizationRoleId
			});
		});
	}

	async function assignUserRole(
		userId,
		roleType,
		roleId,
		organizationId = null,
		subOrganizationId = null
	) {
		switch (roleType) {
			case 'system':
				await db.insert(table.userSystemRole).values({
					userId,
					systemRoleId: roleId
				});
				break;
			case 'organization':
				await db.insert(table.userOrganizationRole).values({
					userId,
					organizationId,
					organizationRoleId: roleId
				});
				break;
			case 'subOrganization':
				await db.insert(table.userSubOrganizationRole).values({
					userId,
					subOrganizationId,
					subOrganizationRoleId: roleId
				});
				break;
		}

		await loadUserRoles();
	}

	async function removeUserRole(
		userId,
		roleType,
		roleId,
		organizationId = null,
		subOrganizationId = null
	) {
		switch (roleType) {
			case 'system':
				await db
					.delete(table.userSystemRole)
					.where(
						and(
							eq(table.userSystemRole.userId, userId),
							eq(table.userSystemRole.systemRoleId, roleId)
						)
					);
				break;
			case 'organization':
				await db
					.delete(table.userOrganizationRole)
					.where(
						and(
							eq(table.userOrganizationRole.userId, userId),
							eq(table.userOrganizationRole.organizationId, organizationId),
							eq(table.userOrganizationRole.organizationRoleId, roleId)
						)
					);
				break;
			case 'subOrganization':
				await db
					.delete(table.userSubOrganizationRole)
					.where(
						and(
							eq(table.userSubOrganizationRole.userId, userId),
							eq(table.userSubOrganizationRole.subOrganizationId, subOrganizationId),
							eq(table.userSubOrganizationRole.subOrganizationRoleId, roleId)
						)
					);
				break;
		}

		await loadUserRoles();
	}
</script>

<svelte:head>
	<title>用户角色管理</title>
</svelte:head>

<div class="user-roles-page">
	<h1>用户角色管理</h1>

	{#if loading}
		<div class="loading">加载中...</div>
	{:else}
		<div class="users-table">
			<table>
				<thead>
					<tr>
						<th>用户</th>
						<th>系统角色</th>
						<th>主组织角色</th>
						<th>子组织角色</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					{#each users as user}
						<tr>
							<td>
								<strong>{user.username}</strong>
								<br />
								<small>{user.email}</small>
							</td>
							<td>
								{#each userRoles[user.id]?.system || [] as roleId}
									{@const role = roles.find((r) => r.id === roleId && r.type === 'system')}
									{#if role}
										<span class="role-tag system">{role.name}</span>
									{/if}
								{/each}
							</td>
							<td>
								{#each userRoles[user.id]?.organization || [] as orgRole}
									{@const role = roles.find(
										(r) => r.id === orgRole.roleId && r.type === 'organization'
									)}
									{#if role}
										<span class="role-tag organization">{role.name}</span>
									{/if}
								{/each}
							</td>
							<td>
								{#each userRoles[user.id]?.subOrganization || [] as subOrgRole}
									{@const role = roles.find(
										(r) => r.id === subOrgRole.roleId && r.type === 'subOrganization'
									)}
									{#if role}
										<span class="role-tag sub-organization">{role.name}</span>
									{/if}
								{/each}
							</td>
							<td>
								<button class="btn-secondary" on:click={() => showRoleAssignmentModal(user.id)}>
									分配角色
								</button>
								是的，文档太长了被截断了。让我继续完成剩余部分： ### 3.5.1 用户角色管理页面（续） ```svelte
							</td>
						</tr>
					{/each}
				</tbody>
			</table>
		</div>
	{/if}
</div>

<style>
	.user-roles-page {
		max-width: 100%;
		margin: 0 auto;
		padding: 2rem;
		overflow-x: auto;
	}

	.users-table table {
		width: 100%;
		border-collapse: collapse;
		background: var(--color-background);
		border-radius: 0.5rem;
		overflow: hidden;
	}

	.users-table th,
	.users-table td {
		padding: 0.75rem;
		text-align: left;
		border-bottom: 1px solid var(--color-border);
	}

	.users-table th {
		background: var(--color-background-soft);
		font-weight: 600;
	}

	.role-tag {
		display: inline-block;
		padding: 0.25rem 0.5rem;
		margin: 0.125rem;
		border-radius: 0.25rem;
		font-size: 0.75rem;
		font-weight: 500;
	}

	.role-tag.system {
		background: var(--color-primary);
		color: white;
	}

	.role-tag.organization {
		background: var(--color-secondary);
		color: white;
	}

	.role-tag.sub-organization {
		background: var(--color-accent);
		color: white;
	}
</style>
````

## 4. 配置文件

### 4.1 权限配置文件

```javascript
// frontend/src/lib/config/permissions.js
export const PERMISSION_CONFIG = {
	// 当前项目配置
	current: {
		hasMultipleOrganizations: true,
		organizationType: 'association',
		subOrganizationType: 'committee',
		defaultOrganizationId: 1
	},

	// 权限定义
	permissions: {
		// 系统级权限
		system: {
			'system:admin': '系统管理员',
			'system:config': '系统配置',
			'system:user_manage': '用户管理'
		},

		// 主组织级权限
		organization: {
			'organization:manage': '组织管理',
			'organization:view': '组织查看',
			'organization:edit': '组织编辑',
			'sub_organization:create': '创建子组织',
			'sub_organization:manage': '管理子组织',
			'sub_organization:view': '查看子组织'
		},

		// 子组织级权限
		subOrganization: {
			'sub_organization:manage': '子组织管理',
			'sub_organization:view': '子组织查看',
			'sub_organization:edit': '子组织编辑',
			'sub_organization:approve': '子组织审批',
			'sub_organization:delete': '子组织删除'
		}
	},

	// 角色定义
	roles: {
		system: [
			{ name: 'admin', description: '系统管理员' },
			{ name: 'super_admin', description: '超级管理员' }
		],
		organization: [
			{ name: '会长', description: '协会会长' },
			{ name: '副会长', description: '协会副会长' },
			{ name: '秘书长', description: '协会秘书长' }
		],
		subOrganization: [
			{ name: '主席', description: '专委会主席' },
			{ name: '副主席', description: '专委会副主席' },
			{ name: '委员', description: '专委会委员' },
			{ name: '秘书', description: '专委会秘书' }
		]
	}
};

// 权限检查函数
export function hasPermission(userPermissions, permission) {
	return userPermissions.includes(permission);
}

// 权限分组函数
export function groupPermissions(permissions) {
	const groups = {
		system: [],
		organization: [],
		subOrganization: []
	};

	permissions.forEach((permission) => {
		if (permission.startsWith('system:')) {
			groups.system.push(permission);
		} else if (
			permission.startsWith('organization:') ||
			permission.startsWith('sub_organization:')
		) {
			if (permission.startsWith('sub_organization:')) {
				groups.subOrganization.push(permission);
			} else {
				groups.organization.push(permission);
			}
		}
	});

	return groups;
}
```

## 5. 开发检查清单

### 5.1 第一阶段检查清单

- [ ] 更新数据库schema
- [ ] 运行数据库迁移
- [ ] 创建权限验证服务
- [ ] 创建权限中间件
- [ ] 测试基础权限验证

### 5.2 第二阶段检查清单

- [ ] 创建权限Store
- [ ] 创建权限按钮组件
- [ ] 创建组织切换器组件
- [ ] 集成到现有页面
- [ ] 测试前端权限组件

### 5.3 第三阶段检查清单

- [ ] 创建角色管理页面
- [ ] 创建权限分配页面
- [ ] 测试角色和权限管理
- [ ] 创建初始角色和权限数据

### 5.4 第四阶段检查清单

- [ ] 创建主组织管理页面
- [ ] 创建子组织管理页面
- [ ] 测试组织管理功能
- [ ] 创建初始组织数据

### 5.5 第五阶段检查清单

- [ ] 创建用户角色管理页面
- [ ] 测试用户角色分配
- [ ] 创建用户权限查看页面
- [ ] 完整测试权限系统

## 6. 测试用例

### 6.1 权限验证测试

```javascript
// 测试权限验证逻辑
describe('权限验证', () => {
	test('系统管理员应该有所有权限', async () => {
		const hasPermission = await checkUserPermission(1, 'system:admin');
		expect(hasPermission).toBe(true);
	});

	test('普通用户不应该有系统管理权限', async () => {
		const hasPermission = await checkUserPermission(2, 'system:admin');
		expect(hasPermission).toBe(false);
	});

	test('组织管理员应该有组织管理权限', async () => {
		const hasPermission = await checkUserPermission(3, 'organization:manage', {
			organizationId: 1
		});
		expect(hasPermission).toBe(true);
	});
});
```

### 6.2 组织切换测试

```javascript
// 测试组织切换功能
describe('组织切换', () => {
	test('用户应该能够切换到有权限的组织', async () => {
		const organizations = await getUserOrganizations(1);
		expect(organizations.length).toBeGreaterThan(0);
	});

	test('用户不应该看到没有权限的组织', async () => {
		const organizations = await getUserOrganizations(2);
		// 验证用户只能看到有权限的组织
	});
});
```

## 7. 部署注意事项

### 7.1 数据库迁移

```bash
# 运行数据库迁移
npm run db:migrate

# 创建初始数据
npm run db:seed
```

### 7.2 环境配置

```javascript
// .env
DATABASE_URL = 'file:./dev.db';
DEFAULT_ORGANIZATION_ID = 1;
ENABLE_PERMISSION_SYSTEM = true;
```

### 7.3 性能优化

- 使用Redis缓存权限数据
- 实现权限预加载
- 优化数据库查询

## 8. 后续扩展

### 8.1 审批流集成

- 基于权限系统实现审批流程
- 支持多级审批
- 审批历史记录

### 8.2 权限审计

- 权限变更日志
- 用户操作审计
- 权限使用统计

### 8.3 高级功能

- 动态权限规则
- 权限继承配置
- 权限模板管理

这个完整的开发文档涵盖了三级权限系统的所有方面，你可以按照这个顺序逐步实现。需要我详细解释某个部分吗？
