# 通知系统开发文档

## 概述

本通知系统支持个人通知和群体通知，采用分离方案设计，提供完整的通知管理功能。

## 技术栈

- **前端**: SvelteKit 2.x + Svelte 5
- **数据库**: SQLite + Drizzle ORM
- **UI**: Tailwind CSS
- **类型**: TypeScript

## 数据库设计

### 1. 通知内容表 (notification)

```sql
CREATE TABLE notification (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL,                    -- 'individual' 或 'group'
    title TEXT NOT NULL,                   -- 通知标题
    content TEXT NOT NULL,                 -- 通知内容
    data JSON,                             -- 额外数据（如链接、参数等）
    is_important BOOLEAN DEFAULT false,    -- 是否重要通知
    created_at INTEGER NOT NULL
);
```

### 2. 群体通知配置表 (group_notification_config)

```sql
CREATE TABLE group_notification_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    notification_id INTEGER NOT NULL,      -- 关联到notification表
    target_type TEXT NOT NULL,             -- 目标类型：'all_users', 'organization', 'role', 'sub_organization', 'custom'
    target_id INTEGER,                     -- 目标ID（组织ID、角色ID等）
    target_conditions JSON,                -- 自定义条件（如年龄范围等）
    created_at INTEGER NOT NULL,
    FOREIGN KEY (notification_id) REFERENCES notification(id)
);
```

### 3. 用户通知状态表 (user_notification)

```sql
CREATE TABLE user_notification (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,              -- 用户ID
    notification_id INTEGER NOT NULL,      -- 通知ID
    is_read BOOLEAN DEFAULT false,         -- 是否已读
    read_at INTEGER,                       -- 阅读时间
    created_at INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES user(id),
    FOREIGN KEY (notification_id) REFERENCES notification(id),
    UNIQUE(user_id, notification_id)
);
```

## 开发步骤

### 第一步：创建数据库迁移

1. 创建迁移文件
2. 运行迁移
3. 创建 Drizzle schema

### 第二步：创建通知服务

1. 创建 NotificationService 类
2. 实现发送个人通知功能
3. 实现发送群体通知功能
4. 实现查询和标记已读功能

### 第三步：创建 API 端点

1. 创建通知列表 API
2. 创建未读数量 API
3. 创建标记已读 API
4. 创建发送通知 API

### 第四步：创建前端组件

1. 创建小铃铛组件
2. 创建通知列表页面
3. 创建发送通知页面
4. 集成到主布局

### 第五步：测试和优化

1. 功能测试
2. 性能优化
3. 用户体验优化

## 详细实现

### 1. 数据库 Schema (Drizzle)

```javascript
// 在 src/lib/server/db/schema.js 中添加以下内容

// 通知内容表
export const notification = sqliteTable('notification', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  type: text('type').notNull(), // 'individual' | 'group'
  title: text('title').notNull(),
  content: text('content').notNull(),
  data: text('data'), // JSON string
	isImportant: boolean('is_important').default(false),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow()
});

// 群体通知配置表
export const groupNotificationConfig = sqliteTable('group_notification_config', {
  id: integer('id').primaryKey({ autoIncrement: true }),
	notificationId: integer('notification_id')
		.notNull()
		.references(() => notification.id),
	targetType: text('target_type').notNull(),
	targetId: integer('target_id'),
	targetConditions: text('target_conditions'), // JSON string
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow()
});

// 用户通知状态表
export const userNotification = sqliteTable('user_notification', {
  id: integer('id').primaryKey({ autoIncrement: true }),
	userId: integer('user_id')
		.notNull()
		.references(() => user.id),
	notificationId: integer('notification_id')
		.notNull()
		.references(() => notification.id),
	isRead: boolean('is_read').default(false),
	readAt: integer('read_at', { mode: 'timestamp' }),
	createdAt: integer('created_at', { mode: 'timestamp' }).notNull().defaultNow()
}, (table) => ({
	pk: unique('user_notification_pk').on(table.userId, table.notificationId)
}));
```

### 2. 通知服务

```typescript
// src/lib/server/services/NotificationService.ts
import { db } from '$lib/server/db';
import { notification, groupNotificationConfig, userNotification, user } from '$lib/server/db/schema';
import { eq, and, or, isNull, inArray } from 'drizzle-orm';
import type { NotificationTarget } from '$lib/types/notification';

export class NotificationService {
  // 发送个人通知
  static async sendIndividualNotification(data: {
    userId: number;
    title: string;
    content: string;
    data?: any;
    isImportant?: boolean;
  }) {
    const [newNotification] = await db.insert(notification).values({
      type: 'individual',
      title: data.title,
      content: data.content,
      data: data.data ? JSON.stringify(data.data) : null,
      is_important: data.isImportant || false,
      created_at: Date.now()
    }).returning();

    await db.insert(userNotification).values({
      userId: data.userId,
      notificationId: newNotification.id,
      createdAt: Date.now()
    });

    return newNotification;
  }

  // 发送群体通知
  static async sendGroupNotification(data: {
    title: string;
    content: string;
    target: NotificationTarget;
    data?: any;
    isImportant?: boolean;
  }) {
    // 1. 创建通知内容
    const [newNotification] = await db.insert(notification).values({
      type: 'group',
      title: data.title,
      content: data.content,
      data: data.data ? JSON.stringify(data.data) : null,
      is_important: data.isImportant || false,
      created_at: Date.now()
    }).returning();

    // 2. 存储群体选择信息
    await db.insert(groupNotificationConfig).values({
      notificationId: newNotification.id,
      targetType: data.target.type,
      targetId: 'id' in data.target ? data.target.id : null,
      targetConditions: 'conditions' in data.target ? JSON.stringify(data.target.conditions) : null,
      createdAt: Date.now()
    });

    // 3. 获取目标用户列表
    const targetUsers = await this.getTargetUsers(data.target);

    // 4. 为每个目标用户创建通知状态记录
    if (targetUsers.length > 0) {
      const userNotifications = targetUsers.map(userId => ({
        userId: userId,
        notificationId: newNotification.id,
        createdAt: Date.now()
      }));

      await db.insert(userNotification).values(userNotifications);
    }

    return newNotification;
  }

  // 获取目标用户列表
  private static async getTargetUsers(target: NotificationTarget): Promise<number[]> {
    switch (target.type) {
      case 'all_users':
        const allUsers = await db.select({ id: user.id }).from(user);
        return allUsers.map(u => u.id);

      case 'organization':
        const orgUsers = await db
          .select({ id: user.id })
          .from(user)
          .innerJoin(user_organization_role, eq(user.id, user_organization_role.user_id))
          .where(eq(user_organization_role.organization_id, target.id));
        return orgUsers.map(u => u.id);

      case 'role':
        const roleUsers = await db
          .select({ id: user.id })
          .from(user)
          .innerJoin(user_role, eq(user.id, user_role.user_id))
          .where(eq(user_role.role_id, target.id));
        return roleUsers.map(u => u.id);

      case 'custom':
        return await this.getUsersByConditions(target.conditions);

      default:
        return [];
    }
  }

  // 根据条件获取用户
  private static async getUsersByConditions(conditions: any): Promise<number[]> {
    // 实现复杂的用户筛选逻辑
    // 这里可以根据年龄、部门、角色等条件筛选
    return [];
  }

  // 获取用户通知列表
  static async getUserNotifications(userId: number, page = 1, limit = 20) {
    const offset = (page - 1) * limit;

    const notifications = await db
      .select({
        id: notification.id,
        type: notification.type,
        title: notification.title,
        content: notification.content,
        data: notification.data,
        is_important: notification.isImportant,
        created_at: notification.createdAt,
        is_read: userNotification.isRead,
        read_at: userNotification.readAt
      })
      .from(notification)
      .innerJoin(userNotification, eq(notification.id, userNotification.notificationId))
      .where(eq(userNotification.userId, userId))
      .orderBy(desc(notification.createdAt))
      .limit(limit)
      .offset(offset);

    return notifications.map(n => ({
      ...n,
      data: n.data ? JSON.parse(n.data) : null
    }));
  }

  // 获取用户未读通知数量
  static async getUnreadCount(userId: number): Promise<number> {
    const [{ count }] = await db
      .select({ count: sql<number>`count(*)` })
      .from(userNotification)
      .where(
        and(
          eq(userNotification.userId, userId),
          eq(userNotification.isRead, false)
        )
      );

    return count;
  }

  // 获取用户通知总数
  static async getTotalCount(userId: number): Promise<number> {
    const [{ count }] = await db
      .select({ count: sql<number>`count(*)` })
      .from(userNotification)
      .where(eq(userNotification.userId, userId));

    return count;
  }

  // 标记通知为已读
  static async markAsRead(notificationId: number, userId: number) {
    await db
      .update(userNotification)
      .set({ 
        isRead: true,
        readAt: Date.now()
      })
      .where(
        and(
          eq(userNotification.notificationId, notificationId),
          eq(userNotification.userId, userId)
        )
      );
  }

  // 批量标记为已读
  static async markMultipleAsRead(notificationIds: number[], userId: number) {
    await db
      .update(userNotification)
      .set({ 
        isRead: true,
        readAt: Date.now()
      })
      .where(
        and(
          inArray(userNotification.notificationId, notificationIds),
          eq(userNotification.userId, userId)
        )
      );
  }
}
```

### 7. 通知列表页面服务端

```typescript
// src/routes/notifications/+page.server.ts
import { error, fail } from '@sveltejs/kit';
import type { PageServerLoad, Actions } from './$types';
import { NotificationService } from '$lib/server/services/NotificationService';

export const load: PageServerLoad = async ({ locals, url }) => {
	const user = locals.user;
	if (!user) {
		error(401, '未登录');
	}

	const page = parseInt(url.searchParams.get('page') || '1');
	const limit = 20;
	const offset = (page - 1) * limit;

	const notifications = await NotificationService.getUserNotifications(user.id, page, limit);
	const unreadCount = await NotificationService.getUnreadCount(user.id);
	const totalCount = await NotificationService.getTotalCount(user.id);

	return {
		notifications,
		totalCount,
		unreadCount,
		currentPage: page,
		totalPages: Math.ceil(totalCount / limit)
	};
};

export const actions: Actions = {
	'mark-all-read': async ({ locals }) => {
		const user = locals.user;
		if (!user) {
			return fail(401, { error: '未登录' });
		}

		await NotificationService.markAllAsRead(user.id);
		return { success: true };
	},

	'mark-read': async ({ locals, request }) => {
		const user = locals.user;
		if (!user) {
			return fail(401, { error: '未登录' });
		}

		const formData = await request.formData();
		const notificationId = parseInt(formData.get('notification_id') as string);

		await NotificationService.markAsRead(notificationId, user.id);
		return { success: true };
	}
};
```

### 8. 发送通知页面

```svelte
<!-- src/routes/notifications/send/+page.svelte -->
<script lang="ts">
	import { enhance } from '$app/forms';

	let targetType = 'all_users';
	let targetId = null;
	let title = '';
	let content = '';
	let isImportant = false;

	const targetOptions = [
		{ value: 'all_users', label: '所有用户' },
		{ value: 'organization', label: '指定组织' },
		{ value: 'role', label: '指定角色' }
	];
</script>

<svelte:head>
	<title>发送通知</title>
</svelte:head>

<div class="container mx-auto max-w-2xl p-4">
	<h1 class="mb-6 text-2xl font-bold">发送通知</h1>

	<form method="POST" use:enhance>
		<div class="space-y-4">
			<div>
				<label class="mb-1 block text-sm font-medium text-gray-700">通知类型</label>
				<select bind:value={targetType} class="w-full rounded-md border border-gray-300 px-3 py-2">
					{#each targetOptions as option}
						<option value={option.value}>{option.label}</option>
					{/each}
				</select>
			</div>

			{#if targetType !== 'all_users'}
				<div>
					<label class="mb-1 block text-sm font-medium text-gray-700">目标选择</label>
					<select
						bind:value={targetId}
						name="target_id"
						class="w-full rounded-md border border-gray-300 px-3 py-2"
					>
						<option value="">请选择</option>
						<!-- 根据targetType动态加载选项 -->
					</select>
				</div>
			{/if}

			<div>
				<label class="mb-1 block text-sm font-medium text-gray-700">标题</label>
				<input
					bind:value={title}
					name="title"
					type="text"
					class="w-full rounded-md border border-gray-300 px-3 py-2"
					required
				/>
			</div>

			<div>
				<label class="mb-1 block text-sm font-medium text-gray-700">内容</label>
				<textarea
					bind:value={content}
					name="content"
					rows="4"
					class="w-full rounded-md border border-gray-300 px-3 py-2"
					required
				></textarea>
			</div>

			<div class="flex items-center">
				<input
					bind:checked={isImportant}
					name="is_important"
					type="checkbox"
					class="rounded border-gray-300"
				/>
				<label class="ml-2 text-sm text-gray-700">重要通知</label>
			</div>

			<button
				type="submit"
				class="w-full rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
			>
				发送通知
			</button>
		</div>
	</form>
</div>
```

### 9. 发送通知页面服务端

```typescript
// src/routes/notifications/send/+page.server.ts
import { error, fail } from '@sveltejs/kit';
import type { PageServerLoad, Actions } from './$types';
import { NotificationService } from '$lib/server/services/NotificationService';

export const load: PageServerLoad = async ({ locals }) => {
	const user = locals.user;
	if (!user) {
		error(401, '未登录');
	}

	// 检查权限
	if (!user.permissions.includes('notification:send')) {
		error(403, '无权限');
	}

	return {};
};

export const actions: Actions = {
	default: async ({ locals, request }) => {
		const user = locals.user;
		if (!user) {
			return fail(401, { error: '未登录' });
		}

		const formData = await request.formData();
		const title = formData.get('title') as string;
		const content = formData.get('content') as string;
		const targetType = formData.get('target_type') as string;
		const targetId = formData.get('target_id') as string;
		const isImportant = formData.get('is_important') === 'on';

		if (!title || !content) {
			return fail(400, { error: '标题和内容不能为空' });
		}

		try {
			await NotificationService.sendGroupNotification({
				title,
				content,
				target: {
					type: targetType as any,
					id: targetId ? parseInt(targetId) : undefined
				},
				isImportant
			});

			return { success: true };
		} catch (error) {
			return fail(500, { error: '发送失败' });
		}
	}
};
```

### 10. 集成到主布局

```svelte
<!-- src/routes/+layout.svelte -->
<script>
	import NotificationBell from '$lib/components/NotificationBell.svelte';
	// ... 其他导入
</script>

<header class="bg-white shadow">
	<div class="container mx-auto flex items-center justify-between px-4 py-4">
		<h1 class="text-xl font-bold">我的应用</h1>

		<div class="flex items-center space-x-4">
			<NotificationBell />
			<!-- 其他导航项 -->
		</div>
	</div>
</header>

<main>
	{@render children()}
</main>
```

### 11. 数据库迁移

```sql
-- drizzle/0003_notification_system.sql
CREATE TABLE notification (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    data TEXT,
    is_important BOOLEAN DEFAULT false,
    created_at INTEGER NOT NULL
);

CREATE TABLE group_notification_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    notification_id INTEGER NOT NULL,
    target_type TEXT NOT NULL,
    target_id INTEGER,
    target_conditions TEXT,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (notification_id) REFERENCES notification(id)
);

CREATE TABLE user_notification (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    notification_id INTEGER NOT NULL,
    is_read BOOLEAN DEFAULT false,
    read_at INTEGER,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES user(id),
    FOREIGN KEY (notification_id) REFERENCES notification(id),
    UNIQUE(user_id, notification_id)
);

-- 创建索引
CREATE INDEX idx_notification_type ON notification(type);
CREATE INDEX idx_notification_created_at ON notification(created_at);
CREATE INDEX idx_user_notification_user_id ON user_notification(user_id);
CREATE INDEX idx_user_notification_read ON user_notification(is_read);
```

### 12. 使用示例

```typescript
// 发送个人通知
await NotificationService.sendIndividualNotification({
	userId: 123,
	title: '您的申请已通过',
	content: '恭喜！您的入会申请已获得批准。',
	isImportant: true
});

// 发送群体通知
await NotificationService.sendGroupNotification({
	title: '系统维护通知',
	content: '系统将于今晚22:00进行维护，期间可能无法正常使用。',
	target: { type: 'all_users' },
	isImportant: true
});

// 发送组织通知
await NotificationService.sendGroupNotification({
	title: '年度会议通知',
	content: '请各位同事准时参加本周五的年度会议。',
	target: { type: 'organization', id: 1 }
});
```

## 开发步骤总结

1. **创建数据库迁移**：运行 `npm run db:generate` 和 `npm run db:push`
2. **添加 Schema 定义**：在 `schema.js` 中添加通知相关表
3. **创建通知服务**：实现 `NotificationService` 类
4. **创建 API 端点**：实现通知相关的 API
5. **创建前端组件**：实现小铃铛和通知页面
6. **集成到布局**：在主布局中添加通知组件
7. **测试功能**：测试个人通知和群体通知功能

这样就完成了完整的通知系统开发！

## 需要补充的内容

### 1. 类型定义文件

```typescript
// src/lib/types/notification.ts
export type NotificationType = 'individual' | 'group';
export type NotificationTargetType = 'all_users' | 'organization' | 'role' | 'sub_organization' | 'custom';

export interface NotificationTarget {
  type: NotificationTargetType;
  id?: number;
  conditions?: any;
}

export interface Notification {
  id: number;
  type: NotificationType;
  title: string;
  content: string;
  data?: any;
  is_important: boolean;
  created_at: number;
  is_read: boolean;
  read_at?: number;
}

export interface NotificationFormData {
  title: string;
  content: string;
  target: NotificationTarget;
  is_important?: boolean;
}
```

### 2. 缺失的 API 端点

```typescript
// src/routes/api/notifications/+server.ts
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { NotificationService } from '$lib/server/services/NotificationService';

export const GET: RequestHandler = async ({ locals, url }) => {
  const user = locals.user;
  if (!user) {
    return json({ error: '未登录' }, { status: 401 });
  }

  const page = parseInt(url.searchParams.get('page') || '1');
  const limit = parseInt(url.searchParams.get('limit') || '20');

  const notifications = await NotificationService.getUserNotifications(user.id, page, limit);
  
  return json(notifications);
};

export const POST: RequestHandler = async ({ locals, request }) => {
  const user = locals.user;
  if (!user) {
    return json({ error: '未登录' }, { status: 401 });
  }

  const data = await request.json();
  
  if (data.type === 'individual') {
    await NotificationService.sendIndividualNotification({
      userId: data.userId,
      title: data.title,
      content: data.content,
      data: data.data,
      isImportant: data.is_important
    });
  } else if (data.type === 'group') {
    await NotificationService.sendGroupNotification({
      title: data.title,
      content: data.content,
      target: data.target,
      data: data.data,
      isImportant: data.is_important
    });
  }

  return json({ success: true });
};
```

### 3. 缺失的方法

```typescript
// 在 NotificationService 中添加缺失的方法
static async markAllAsRead(userId: number) {
  await db
    .update(userNotification)
    .set({ 
      isRead: true, 
      readAt: Date.now() 
    })
    .where(eq(userNotification.userId, userId));
}
```

## 总结

文档基本完整，包含：

✅ **完整的内容**：
- 数据库设计
- Schema 定义
- 通知服务（大部分）
- 前端组件
- 页面实现
- API 端点
- 使用示例
- 开发步骤

⚠️ **需要补充**：
- 类型定义文件
- 一些缺失的方法实现
- 完整的 API 端点

文档已经足够详细，可以开始开发了！你可以按照开发步骤逐步实现。
   